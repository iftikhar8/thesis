---
title: "Linear mixed model analysis for length"
output:
  pdf_document: default
  html_notebook: default
---

```{r, include=FALSE}
require(tidyverse)
require(car)
require(MASS)
require(lmerTest)
require(lme4)
require(lsmeans)
```


The data is not normally distributed (log normal distribution). 

SEE: https://stats.stackexchange.com/questions/181034/post-hoc-test-of-interaction-factor-in-binomial-glmm-with-proportions
https://cran.r-project.org/web/packages/lsmeans/vignettes/using-lsmeans.pdf

Read in and tidy the data
```{r}
# The two data sets, one containing measuresments, the other tow information
data <- read_csv("../../data/ichthyoplankton-measurements.csv")
data.tow <- read_csv("../../data/ichthyoplankton-tow.csv")

# Select relevant columns
data <- filter(data, family != "bothid" & family != "triglid")
data <- filter(data, is.na(not_calibrated), is.na(damaged))
data <- dplyr::select(data, -subgroup, -photo_id, -damaged, -not_calibrated)

# Create factors (tibble does not import as factors)
data$stage <- factor(data$stage, levels = c("PRE", "FLE", "POS"))
data$family <- as.factor(data$family)
data$net <- as.factor(data$net)
data$depth <- as.factor(data$depth)
data$preservation_method <- as.factor(data$preservation_method)
data$feature <- as.factor(data$feature)
data$location <- as.factor(data$location)
data$station <- as.factor(data$station)
data$site <- as.factor(data$site)
data.tow$net <- as.factor(data.tow$net_number)
data.tow$feature <- as.factor(data.tow$feature)
data.tow$feature_name <- as.factor(data.tow$feature_name)
data.tow$location <- as.factor(data.tow$location)
data.tow$site <- as.factor(data.tow$site)
data.tow$station <- as.factor(data.tow$station)

data.length.raw <- mutate(data, total_length = standard_length + caudal_fin_length)
data.length.feature <- summarize(group_by(data.length.raw, feature, family), length_mean = mean(total_length), length_sd = sd(total_length), length_se = length_sd/n())
data.length.depth <- summarize(group_by(data.length.raw, depth, family), length_mean = mean(total_length), length_sd = sd(total_length), length_se = length_sd/n())

```

```{r}
overdispersed <- function(model) {
  ## number of variance parameters in 
  ##   an n-by-n variance-covariance matrix
  vpars <- function(m) {
    nrow(m)*(nrow(m)+1)/2
  }
  model.df <- sum(sapply(VarCorr(model),vpars))+length(fixef(model))
  rdf <- nrow(model.frame(model))-model.df
  rp <- residuals(model,type="pearson")
  Pearson.chisq <- sum(rp^2)
  prat <- Pearson.chisq/rdf
  pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE)
  c(chisq=Pearson.chisq,ratio=prat,rdf=rdf,p=pval)
}
```


# The Model

The factors chosen:
- Location. They were at different latitudes, so there are sst / salinty / chlorophyll differences (and I'm sure more variables)
- Feature. The water type was either from coastal source water or from inside an eddy
- Station. 3 stations within a feature
- Depth. The three depths the fish were caught at.
- Stage. The three stages of ontogeny the fish were measured at


| Independent factors | Type   | Levels | Nested | Values                             |
|:--------------------|:-------|:-------|:-------|:-----------------------------------|
| location            | random | 2      | no     | NA                                 |
| feature             | fixed  | 2      | no     | coastal, eddy                      |
| station             | random | 3      | yes    | NA                                 |
| depth               | fixed  | 3      | no     | 0, 25, 75                          |


Unit of replication = 2 (net)

| Dependent factor | Transformation | Units |
|:-----------------|:---------------|:------|
| Length    | log(x)       | mm |

Transformation as per Underwood for concentration data. Also x1000 to get concentrations at 250m^3. The idea of increasing it was get large enough values so the logarithm transformation was monotomic. Plotting the mean and sd before and after the log transformation.exce

# Labrid

```{r}
labrid.data <- filter(data.length.raw, family == "labridae")
```

## Patterns
```{r}
labrid.sum <- filter(data.length.feature, family == "labridae")
ggplot(data=labrid.sum, aes(y=length_mean, x=feature)) + geom_line() + geom_errorbar(aes( ymin = length_mean-length_se, ymax = length_mean+length_se),width=.1) + geom_point()
labrid.sum <- filter(data.length.depth, family == "labridae")
ggplot(data=labrid.sum, aes(y=length_mean, x=depth)) + geom_line() + geom_errorbar(aes( ymin = length_mean-length_se, ymax = length_mean+length_se),width=.1) + geom_point()
```


## Distribution

None are a good fit for the labrid data
```{r}
hist(labrid.data$total_length)
labrid.data$total_length.t <- labrid.data$total_length + 1
qqp(labrid.data$total_length, "norm")
poisson <- fitdistr(labrid.data$total_length, "Poisson")
qqp(labrid.data$total_length, "pois", poisson$estimate)
gamma <- fitdistr(labrid.data$total_length, "gamma")
qqp(labrid.data$total_length, "gamma", shape=gamma$estimate[[1]], rate = gamma$estimate[[2]])
```
## Distribution (Transformed data)

Only when we transform the data using log do we get a good quantile fit for a LM
```{r}
labrid.data <- mutate(labrid.data, length_log = log(total_length))
qqp(labrid.data$length_log, "norm")
```

## Model
```{r}
labrid.lme <- lmer(length_log ~ feature * depth + (1 | location) + (1 | feature : station),  data=labrid.data)
summary(labrid.lme)
```


## Anova
```{r}
Anova(labrid.lme, type="III")
```

## Model test
```{r}
labrid.model <- lmer(total_length ~ feature * depth + (1 | location) + (1 | feature : station), data=labrid.data, REML = FALSE)
labrid.null <-  lmer(total_length ~ feature + depth + (1 | location) + (1 | feature : station), data=labrid.data, REML=FALSE)
anova(labrid.null, labrid.model)
```

## Interaction diagram
```{r}
lsmip(labrid.lme, feature ~ depth)
lsmip(labrid.lme, ~ depth)
lsmip(labrid.lme, ~ feature)
```

## Post-hoc tests

### Depth post-hoc
```{r}
lsmeans(labrid.lme, ~ depth)
summary(pairs(lsmeans(labrid.lme, ~ depth)), type = "response")
```

# Mullid
```{r}
mullid.data <- filter(data.length.raw, family == "mullidae")
```


# Distribution
```{r}
mullid.data <- mutate(mullid.data, length_log = log(total_length))
qqp(mullid.data$length_log, "norm")
```

## Model
```{r}
mullid.lme <- lmer(length_log ~ feature * depth + (1 | location) + (1 | feature : station), data=mullid.data)
summary(mullid.lme)
overdispersed(mullid.lme)
```

## Anova
```{r}
Anova(mullid.lme, type="III")
```

## Interaction diagram (although no significant interaction?)
```{r}
lsmip(mullid.lme, feature ~ depth)
lsmip(mullid.lme, ~ feature)
lsmip(mullid.lme, ~ depth)
```

## Post-hoc tests


### Depth
```{r}
lsmeans(mullid.lme, ~ depth)
summary(pairs(lsmeans(mullid.lme, ~ depth)), type = "response")
```

### Feature
```{r}
lsmeans(mullid.lme, ~ feature)
summary(pairs(lsmeans(mullid.lme, ~ feature)), type = "response")
```


# Pomacentridae
```{r}
pomacentrid.data <- filter(data.length.raw, family == "pomacentridae")
```

## Distribution
```{r}
qqp(pomacentrid.data$total_length, "lnorm")
```

## Model
```{r}
pomacentrid.glmm <- glmer(total_length ~ feature * depth + (1 | location) + (1 | feature : station), family=gaussian(link="log"), data=pomacentrid.data)
summary(pomacentrid.glmm)
```

## Interaction diagram (although no interaction)
```{r}
lsmip(pomacentrid.glmm, feature ~ depth)
lsmip(pomacentrid.glmm, ~ depth)
lsmip(pomacentrid.glmm, ~ feature)
```

## Post-hoc tests

### Feature
```{r}
lsmeans(pomacentrid.glmm, ~ feature)
summary(pairs(lsmeans(pomacentrid.glmm, ~ feature)), type = "response")
```

### Depth
```{r}
lsmeans(pomacentrid.glmm, ~ depth)
summary(pairs(lsmeans(pomacentrid.glmm, ~ depth)), type = "response")
```

# Scaridae
```{r}
scarid.data <- filter(data.length.raw, family == "scaridae")
```

## Distribution
```{r}
qqp(scarid.data$total_length, "lnorm")
```

## Model
```{r}
scarid.glmm <- glmer(total_length ~ feature * depth + (1 | location) + (1 | feature : station), family=gaussian(link="log"),data=scarid.data)
summary(scarid.glmm)
```

## Anova
```{r}
Anova(scarid.glmm, type = "III")
```

## Interaction diagram (although no significant interaction)
```{r}
lsmip(scarid.glmm, feature ~ depth)
lsmip(scarid.glmm, ~ depth)
lsmip(scarid.glmm, ~ feature)
```

## Post-hoc tests
### Feature * Depth Interaction
```{r}
lsmeans(scarid.glmm, ~ feature*depth)
summary(pairs(lsmeans(scarid.glmm, ~ feature*depth)), type = "response")
```

### Feature 
```{r}
lsmeans(scarid.glmm, ~ feature)
summary(pairs(lsmeans(scarid.glmm, ~ feature)), type = "response")
```




# Scorpionfish
```{r}
scorpaenid.data <- filter(data.length.raw, family == "scorpaenidae")
```

## Distribution
```{r}
qqp(scorpaenid.data$total_length, "norm")
```
## Model
```{r}
scorpaenid.lme <- lmer(total_length ~ feature * depth + (1 | location) + (1 | feature : station), data=scorpaenid.data)
summary(scorpaenid.lme)
```

## Anova
```{r}
Anova(scorpaenid.lme, type="III")
```

## Interaction diagram
```{r}
lsmip(scorpaenid.lme, feature ~ depth)
lsmip(scorpaenid.lme, ~ depth)
lsmip(scorpaenid.lme, ~ feature)
```

## Post-hoc tests

### Feature
```{r}
lsmeans(scorpaenid.lme, ~ feature)
summary(pairs(lsmeans(scorpaenid.lme, ~ feature)), type = "response")
```

### Depth
```{r}
lsmeans(scorpaenid.lme, ~ depth)
summary(pairs(lsmeans(scorpaenid.lme, ~ depth)), type = "response")
```

# Lizardfish
```{r}
synodontid.data <- filter(data.length.raw, family == "synodontidae")
```

## Distribution
```{r}
qqp(synodontid.data$total_length, "lnorm")
synodontid.data <- mutate(synodontid.data, length_log = log(total_length))
qqp(synodontid.data$length_log, "norm")
```
## Model
```{r}
synodontid.lmer <- lmer(length_log ~ feature * depth + (1 | location) + (1 | feature : station), data=synodontid.data)
summary(synodontid.lmer)
```

## Anova
```{r}
Anova(synodontid.lmer, type="III")
```

## Interaction diagram
```{r}
lsmip(synodontid.lmer, feature ~ depth)
lsmip(synodontid.lmer, ~ depth)
lsmip(synodontid.lmer, ~ feature)
```

## Post-hoc tests

### Feature
```{r}
lsmeans(synodontid.lmer, ~ feature)
summary(pairs(lsmeans(synodontid.lmer, ~ feature)), type = "response")
```

### Depth
```{r}
lsmeans(synodontid.lmer, ~ depth)
summary(pairs(lsmeans(synodontid.lmer, ~ depth)), type = "response")
```

# Parrotfish
```{r}
serranid.data <- filter(data.length.raw, family == "serranidae")
```

## Distribution
```{r}
serranid.data <- mutate(serranid.data, length_log = log(total_length))
qqp(serranid.data$length_log, "norm")
qqp(serranid.data$total_length, "norm")
qqp(serranid.data$total_length, "lnorm")
gamma <- fitdistr(serranid.data$total_length, "gamma")
qqp(serranid.data$total_length, "gamma", shape=gamma$estimate[[1]], rate = gamma$estimate[[2]])
```
## Model
```{r}
serranid.lmer <- lmer(length_log ~ feature * depth + (1 | location) + (1 | feature : station), data=serranid.data)
summary(serranid.lmer)
```

## Anova
```{r}
Anova(serranid.glmm, type="III")
```

## Interaction diagram
```{r}
lsmip(serranid.glmm, feature ~ depth)
lsmip(serranid.glmm, ~ depth)
lsmip(serranid.glmm, ~ feature)
```

## Post-hoc tests

### Depth 
```{r}
lsmeans(serranid.glmm, ~ depth)
summary(pairs(lsmeans(serranid.glmm, ~ depth)), type = "response")
```
### Feature 
```{r}
lsmeans(serranid.glmm, ~ feature)
summary(pairs(lsmeans(serranid.glmm, ~ feature)), type = "response")
```