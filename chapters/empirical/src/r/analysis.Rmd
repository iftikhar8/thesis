# Analysis steps for empirical chapter

Two facets for each analysis, a total taxa trend for reef fish, and looking at the 7 individual families.

```{r, include=FALSE}
library("tidyverse")
library("lintr")
library("car")
```

Read in and tidy the data
```{r}
data <- read_csv("../../data/ichthyoplankton-measurements.csv")
data.tow <- read_csv("../../data/ichthyoplankton-tow.csv")

# Select relevant data
data <- filter(data, family != "bothid" & family != "triglid")
data <- filter(data, is.na(not_calibrated), is.na(damaged))
data <- select(data, -subgroup, -photo_id, -damaged, -not_calibrated)

# Create factors
data$stage <- factor(data$stage, levels = c("PRE", "FLE", "POS"))
data$family <- as.factor(data$family)
data$net <- as.factor(data$net)
data$depth <- as.factor(data$depth)
data$preservation_method <- as.factor(data$preservation_method)
data$feature <- as.factor(data$feature)
data$location <- as.factor(data$location)
data$station <- as.factor(data$station)
data$site <- as.factor(data$site)

data.tow$net <- as.factor(data.tow$net_number)
data.tow$feature <- as.factor(data.tow$feature)
data.tow$feature_name <- as.factor(data.tow$feature_name)
data.tow$location <- as.factor(data.tow$location)
data.tow$site <- as.factor(data.tow$site)
data.tow$station <- as.factor(data.tow$station)

data.length.raw <- mutate(data, total_length = standard_length + caudal_fin_length)

data.stage <- summarize(group_by(data, location, station, feature, net, family,
                               stage), count = n())

data.spread <- spread(data.stage, key=stage, value=count, drop =FALSE, fill = 0)
data.gather <- gather(data.spread, key=stage, value=count, PRE, POS, FLE, na.rm = FALSE)

data.conc <- data.gather %>% left_join(data.tow) %>% mutate(concentration = count/volume * 250) %>% filter(site != "4", site != "8", site != "12", site != "16")
data.conc <- mutate(data.conc, concentration_log = log(concentration + 1),
                             depth = if_else(net == 'N1' || net == 'N2', 0, if_else(net == 'M5' || net == 'M4', 25 ,75)))
data.conc$depth <- as.factor(data.conc$depth)

data.summary.total <- summarise(group_by(data.conc, location, feature, depth,
                                          stage), sum_conc=sum(concentration_log), mean_conc = mean(concentration), sd_conc = sd(concentration), mean_conc_log = mean(concentration_log), sd_conc_log = sd(concentration_log))

```


## Aim 1: Does stage predict depth

The design of the experiment is unbalanced, as we lost one surface tow at site 8 to a broken logger and we lost one surface tow at site 16 to rough weather. Therefore to balance the design up, we removed the offending sites, and two extra sites for balance.

### Exploratory graphs

Graph concentration as a factor of stage, grouped by depth

```{r}
ggplot(aes(x=depth, y=concentration_log), data=data.all)
```


### Model



| Independent factors | Type   | Levels | Nested | Values                             |
|:--------------------|:-------|:-------|:-------|------------------------------------|
| location            | fixed  | 2      | no     | north, south                       |
| feature             | fixed  | 2      | no     | coastal, eddy                      |
| depth               | fixed  | 3      | no     | 0, 25, 75                          |
| stage               | fixed  | 3      | no     | pre-flexion, flexion, post-flexion |

Unit of replication = net (2)

| Dependent factor | Transformation |
|:-----------------|:---------------|
| Concentration    | log(x+1)       |

Transformation as per Underwood for concentration data.

```{r}
ggplot(data = data.summary.total, aes(x = mean_conc, y = sd_conc)) + geom_point()
ggplot(data = data.summary.total, aes(x = mean_conc_log, y = sd_conc_log)) + geom_point()
```


ANOVAs to reproduce:
One for total trends.
One per each fish family.

#### Total reef fish
```{r}
model.conc <- lm(concentration_log ~ location * feature * depth * stage, data=data.conc)
Anova(model.conc, type = "II")
```

#### Labridae
```{r}
data.conc.labrid <- filter(data.conc, family == "labridae")
model.conc.labrid <- lm(concentration_log ~ location * station / feature * depth * stage, data=data.conc.labrid)
Anova(model.conc.labrid, type = "II")
```

#### Mullidae
```{r}
data.conc.mullid <- filter(data.conc, family == "mullidae")
model.conc.mullid <- lm(concentration_log ~ location * station / feature * depth * stage, data=data.conc.mullid)
Anova(model.conc.mullid, type = "II")
```

#### Pomcentridae
```{r}
data.conc.pom <- filter(data.conc, family == "pomacentridae")
model.conc.pom <- lm(concentration_log ~ location * station / feature * depth * stage, data=data.conc.pom)
Anova(model.conc.pom, type = "II")
```

#### Scaridae
```{r}
data.conc.scarid <- filter(data.conc, family == "scaridae")
model.conc.scarid <- lm(concentration_log ~ location * station / feature * depth * stage, data=data.conc.scarid)
Anova(model.conc.scarid, type = "II")
```

#### Scorpaenidae
```{r}
data.conc.scorp <- filter(data.conc, family == "scorpaenidae")
model.conc.scorp <- lm(concentration_log ~ location * station / feature * depth * stage, data=data.conc.scorp)
Anova(model.conc.scorp, type = "II")
```

#### Serranidae
```{r}
data.conc.serr <- filter(data.conc, family == "serranidae")
model.conc.serr <- lm(concentration_log ~ location * station / feature * depth * stage, data=data.conc.serr)
Anova(model.conc.serr, type = "II")
```

#### Synodontidae
```{r}
data.conc.syn <- filter(data.conc, family == "synodontidae")
model.conc.syn <- lm(concentration_log ~ location * station / feature * depth * stage, data=data.conc.syn)
Anova(model.conc.syn, type = "II")
```

## Aim 2: Does length predict depth

| Independent factors | Type   | Levels | Values                             |
|:--------------------|:-------|:-------|------------------------------------|
| location            | fixed | 2      | north, south                       |
| feature             | fixed  | 2      | coastal, eddy                      |                  
| depth              | fixed  | 3      | 0, 25, 75                          |

#### Total reef fish
```{r}
model.length <- lm(total_length ~ location * station / feature * depth, data=data.length.raw)
alias(model.length)
Anova(model.length, type="III")
```

#### Labridae
```{r}
data.length.labrid <- filter(data.length.raw, family == "labridae")
model.length.labrid <- lm(total_length ~ location * station / feature * depth, data=data.length.labrid)
Anova(model.length.labrid, type="III")
```

#### Mullidae
```{r}
data.length.mullid <- filter(data.length.raw, family == "mullidae")
model.length.mullid <- lm(total_length ~ location * station / feature * depth, data=data.length.mullid)
Anova(model.length.mullid, type="III")
```

#### Pomcentridae
```{r}
data.length.pom <- filter(data.length.raw, family == "pomacentridae")
model.length.pom <- lm(total_length ~ location * station / feature * depth, data=data.length.pom)
Anova(model.length.pom, type="III")
```

#### Scaridae
```{r}
data.length.scarid <- filter(data.length.raw, family == "scaridae")
model.length.scarid <- lm(total_length ~ location * station / feature * depth, data=data.length.scarid)
Anova(model.length.scarid)
```

#### Scorpaenidae
```{r}
data.length.scorp <- filter(data.length.raw, family == "scorpaenidae")
model.length.scorp <- lm(total_length ~ location * station / feature * depth, data=data.length.scorp)
Anova(model.length.scorp)
```

#### Serranidae
```{r}
data.length.serr <- filter(data.length.raw, family == "serranidae")
model.length.serr <- lm(total_length ~ location * station / feature * depth, data=data.length.serr)
Anova(model.length.serr)
```

#### Synodontidae
```{r}
data.length.syn <- filter(data.length.raw, family == "synodontidae")
model.length.syn <- lm(total_length ~ location * station / feature * depth, data=data.length.syn)
alias(model.length.syn)
Anova(model.length.syn, type="III")
```