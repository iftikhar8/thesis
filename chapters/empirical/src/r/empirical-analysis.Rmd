---
title: "Empirical analysis"
output:
  word_document: default
  pdf_document: default
  html_notebook: default
---

# The analysis of my empirical chapter - ORLE methods 

```{r Packages, include=FALSE}
require(tidyverse)
library(corrr)
library(MASS)
library(lsmeans)
library(lme4)
require(pscl)
require(boot)
```

```{r Load data, include=FALSE}
load(file="length.RData")
load(file="ontogeny.RData")
```




# Exploratory analysis

## Check for correlations - any correlated enough to remove??? To me DO and Chloro look highly correlated
```{r}
data.environment <- data.ontogeny %>% ungroup() %>% dplyr::select(temperature, salinity, chlorophyll_fluorescence, dissolved_oxygen) 
correlate(data.environment)
```

## What does the data look like?
```{r}
ggplot(data=data.ontogeny, aes(conc)) + 
  geom_histogram(breaks=seq(0, 0.15, by=0.001)) + facet_wrap(~ family) + labs(x="concentration")
```


```{r Explore ontogeny data}
#data.ontogeny.summary <- na.omit(data.ontogeny)
data.ontogeny.interaction_ds <-  summarize(group_by(na.omit(data.ontogeny), family, depth,stage), conc.mean = mean(conc), conc.se = sd(conc)/n())
data.ontogeny.interaction_fds <-  summarize(group_by(na.omit(data.ontogeny), feature, family, depth,stage), conc.mean = mean(conc), conc.se = sd(conc)/n())
data.ontogeny.depth <-  summarize(group_by(na.omit(data.ontogeny), family, depth), conc.mean = mean(conc), conc.se = sd(conc)/n())
data.ontogeny.stage <-  summarize(group_by(na.omit(data.ontogeny), family, stage), conc.mean = mean(conc), conc.se = sd(conc)/n())
data.ontogeny.feature <-  summarize(group_by(na.omit(data.ontogeny), family, feature), conc.mean = mean(conc), conc.se = sd(conc)/n())

ggplot(aes(y=conc.mean, x=depth, group=stage, colour=stage), data=data.ontogeny.interaction_ds) + geom_point() + geom_line() + geom_errorbar(aes(ymin=conc.mean-conc.se,ymax=conc.mean+conc.se),width=.1) + facet_wrap(~family, scales = "free")

ggplot(aes(y=conc.mean, x=depth, group=family), data=data.ontogeny.depth) + geom_point(aes(colour=family)) + geom_line(aes(colour=family))
ggplot(aes(y=conc.mean, x=stage, group=family), data=data.ontogeny.stage) + geom_point(aes(group=family, colour=family)) + geom_line(aes(colour=family))
ggplot(aes(y=conc.mean, x=feature, group=family), data=data.ontogeny.feature) + geom_point(aes(group=family, colour=family)) + geom_line(aes(colour=family))

ggplot(aes(y=conc.mean, x=depth, group=stage, colour=stage), data=data.ontogeny.interaction_fds) + geom_point() + geom_line() + facet_grid(feature ~ family, scales = "free")

ggplot(data=na.omit(data.ontogeny), aes(y=conc, x=temperature)) + geom_jitter(aes(colour = family)) + stat_smooth(aes(colour=family), method="lm", se=FALSE)
ggplot(data=na.omit(data.ontogeny), aes(y=conc, x=salinity)) + geom_jitter(aes(colour = family)) + stat_smooth(aes(group=family, colour=family),method="lm",se=FALSE)
ggplot(data=na.omit(data.ontogeny), aes(y=conc, x=chlorophyll_fluorescence)) + geom_jitter(aes(colour = family)) + stat_smooth(aes(colour=family), method="lm",se=FALSE)
ggplot(data=na.omit(data.ontogeny), aes(y=conc, x=dissolved_oxygen)) + geom_jitter(aes(colour = family)) + stat_smooth(aes(group=family,colour=family), method="lm",se=FALSE)

```

```{r Zero inflated data %}
get_percentage_zeros(data.ontogeny)
```

# Labrid
## Ontogeny
```{r}
summary(model.ontogeny.lab <- zeroinfl(count ~ offset(log(volume)) + feature*stage + depth*stage + temperature.scale + chloro.scale,  dist="negbin", link="logit", data=data.ontogeny))
```

## Length
```{r}
summary(model.length.full <- glm(total_length ~ feature*depth + temperature + chlorophyll_fluorescence, family = gaussian(link="log"), data=data.length))
```


# Mullid

## Ontogeny
```{r}
summary(model.ontogeny.depthstage.zinb <- zeroinfl(count ~ offset(log(volume)) + depth*stage +  do.scale + temperature.scale,  dist="negbin", link="logit", data=data.ontogeny),control = glm.control(maxit=200))
```


## Length
```{r}
summary(model.length.mul <- glm(total_length ~ feature + depth + temperature, family = gaussian(link="log"), data=data.length))

```


# Pomacentidae

## Ontogeny

Seperation in the pomacentrid data, meant we combine the post-flexion and flexion stages


```{r}

data.ontogeny$stage.posfle <- data.ontogeny$stage %>% fct_collapse(POSFLE = c("POS","FLE"))

summary(model.ontogeny.pom <- zeroinfl(count ~ offset(log(volume)) + feature + depth*stage.comb + temp.scale + do.scale, dist="negbin", link="logit", data=data.ontogeny))

data.ontogeny.pom.lsmfeature <- lsmeans(model.ontogeny.pom, ~feature, transform="response")
summary(data.ontogeny.pom.lsmfeature)

```

## Length
```{r}
summary(model.length.pom <- glm(total_length ~ feature + depth + dissolved_oxygen, family = gaussian(link="log"), data=data.length))
model.length.pom.lsdepth <- lsmeans(model.length.pom, ~depth, transform="response")
summary(model.length.pom.lsdepth)
pairs(model.length.pom.lsdepth)
plot(model.length.pom) 
```

# Scaridae

## Ontogeny
```{r}
summary(model.ontogeny.featuredepthstage.zinb <- zeroinfl(count ~ offset(log(volume)) + feature*depth*stage.prefle + temperature.scale,  dist="negbin", link="logit", data=data.ontogeny))
```

## Length
```{r}
summary(model.length.full <- glm(total_length ~ feature*depth + temperature.scale, family = gaussian(link="log"), data=data.length))
```

# Scorpaenidae

## Ontogeny

Not enough caught at both features to test for 
```{r}
model.ontogeny.sco <- zeroinfl(count ~ offset(log(volume)) + depth*stage + temperature.scale, dist="negbin", link="logit", data=data.ontogeny, maxit = 1000)
```


## Length

# Serranidae

## Ontogeny
```{r}
summary(model.ontogeny.serranid.zinb <- zeroinfl(count ~ offset(log(volume)) + depth*stage + scale(salinity) + scale(dissolved_oxygen),  dist="negbin", link="logit", data=filter(data.ontogeny, family=="serranidae")))
```

## Length
```{r}
summary(model.length.ser <- glm(total_length ~ feature + depth + scale(temperature), family = gaussian(link="log"), data=filter(data.length, family=="serranidae")))
```

# Synodontid

## Ontogeny
```{r}
summary(model.ontogeny.syd.zinb <- zeroinfl(count ~ offset(log(volume)) + depth*stage +scale(temperature),  dist="negbin", link="logit", data=filter(data.ontogeny, family=="synodontidae")))
model.ontogeny.syd.lsm <- lsmeans(model.ontogeny.syd.zinb, ~depth*stage)
```

## Length
```{r}
summary(model.length.full <- glm(total_length ~ feature, family = gaussian(link="log"), data=filter(data.length, family=="synodontidae")))
```



