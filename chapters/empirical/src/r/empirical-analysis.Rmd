---
title: "Empirical analysis"
output:
  word_document: default
  pdf_document: default
  html_notebook: default
---

# The analysis of my empirical chapter - ORLE methods 

```{r Packages, include=FALSE}
library(tidyverse)
library(corrr)
library(MASS)
library(lsmeans)
library(lme4)
library(pscl)
library(boot)
library(DHARMa)
library(AER)
library(multcomp)
library(multcompView)
library(stargazer)
```

```{r Load data, include=FALSE}
load(file="length.RData")
load(file="ontogeny.RData")
load(file="tow.RData")
source("empirical-functions.R")

data.ontogeny$stage <- factor(data.ontogeny$stage, levels=c("PRE","FLE","POS"))
```




# Exploratory analysis

## Check for correlations. DO and Chloro look highly correlated - so only include one in any model
```{r}
data.environment <- data.ontogeny %>% ungroup() %>% dplyr::select(temperature, salinity, chlorophyll_fluorescence, dissolved_oxygen) 
correlate(data.environment)
```

## What does the data look like?

Looks like poisson or negative binomial distributions - with perhaps a tendency to be zero-inflated? Some have a lot of zeros in the output.

```{r}
ggplot(data=data.ontogeny, aes(conc)) + geom_histogram() + facet_wrap(~ family, scales="free") + labs(x="count")
```

```{r}
#ggplot(data=data.tow, aes(temperature~depth)) + geom_bar()
```


```{r Explore ontogeny data}
#data.ontogeny.summary <- na.omit(data.ontogeny)
data.ontogeny.interaction_ds <-  summarize(group_by(na.omit(data.ontogeny), family, depth,stage), conc.mean = mean(conc), conc.se = sd(conc)/n())
data.ontogeny.interaction_fds <-  summarize(group_by(na.omit(data.ontogeny), feature, family, depth,stage), conc.mean = mean(conc), conc.se = sd(conc)/n())
data.ontogeny.depth <-  summarize(group_by(na.omit(data.ontogeny), family, depth), conc.mean = mean(conc), conc.se = sd(conc)/n())
data.ontogeny.stage <-  summarize(group_by(na.omit(data.ontogeny), family, stage), conc.mean = mean(conc), conc.se = sd(conc)/n())
data.ontogeny.feature <-  summarize(group_by(na.omit(data.ontogeny), family, feature), conc.mean = mean(conc), conc.se = sd(conc)/n())

ggplot(aes(y=conc.mean, x=depth, group=stage, colour=stage), data=data.ontogeny.interaction_ds) + geom_point() + geom_line() + geom_errorbar(aes(ymin=conc.mean-conc.se,ymax=conc.mean+conc.se),width=.1) + facet_wrap(~family, scales = "free")

ggplot(aes(y=conc.mean, x=depth, group=family), data=data.ontogeny.depth) + geom_point(aes(colour=family)) + geom_line(aes(colour=family))
ggplot(aes(y=conc.mean, x=stage, group=family), data=data.ontogeny.stage) + geom_point(aes(group=family, colour=family)) + geom_line(aes(colour=family))
ggplot(aes(y=conc.mean, x=feature, group=family), data=data.ontogeny.feature) + geom_point(aes(group=family, colour=family)) + geom_line(aes(colour=family))

ggplot(aes(y=conc.mean, x=depth, group=stage, colour=stage), data=data.ontogeny.interaction_fds) + geom_point() + geom_line() + facet_grid(feature ~ family, scales = "free")

ggplot(data=na.omit(data.ontogeny), aes(y=conc, x=temperature)) + geom_jitter(aes(colour = family)) + stat_smooth(aes(colour=family), method="lm", se=FALSE)
ggplot(data=na.omit(data.ontogeny), aes(y=conc, x=salinity)) + geom_jitter(aes(colour = family)) + stat_smooth(aes(group=family, colour=family),method="lm",se=FALSE)
ggplot(data=na.omit(data.ontogeny), aes(y=conc, x=chlorophyll_fluorescence)) + geom_jitter(aes(colour = family)) + stat_smooth(aes(colour=family), method="lm",se=FALSE)
ggplot(data=na.omit(data.ontogeny), aes(y=conc, x=dissolved_oxygen)) + geom_jitter(aes(colour = family)) + stat_smooth(aes(group=family,colour=family), method="glm",se=FALSE)

```

Environmental data
```{r}
# Column graph
#data.ontogeny <- mutate(data.ontogeny, conc.m = conc*1000)
#data.ontogeny$stage.r <- factor(data.ontogeny$stage, levels=c("POS","FLE","PRE"))
#data.ontogeny$depth.r <- factor(data.ontogeny$depth, levels=c("75","25","0"))
ggplot(data=data.ontogeny, aes(y=temperature, x=depth.r)) + stat_summary_bin(fun.y="mean", geom="point") + stat_summary(fun.data = "mean_cl_boot", geom = "linerange") + labs(x="Depth", y="Concentration (100m^3)") + theme_classic() + coord_flip()
ggplot(data=data.ontogeny, aes(y=salinity, x=depth.r)) + stat_summary_bin(fun.y="mean", geom="point") + stat_summary(fun.data = "mean_cl_boot", geom = "linerange") + labs(x="Depth", y="Concentration (100m^3)") + theme_classic() + coord_flip()
ggplot(data=data.ontogeny, aes(y=dissolved_oxygen, x=depth.r)) + stat_summary_bin(fun.y="mean", geom="point") + stat_summary(fun.data = "mean_cl_boot", geom = "linerange") + labs(x="Depth", y="Concentration (100m^3)") + theme_classic() + coord_flip()
ggplot(data=data.ontogeny, aes(y=chlorophyll_fluorescence, x=depth.r)) + stat_summary_bin(fun.y="mean", geom="point") + stat_summary(fun.data = "mean_cl_boot", geom = "linerange") + labs(x="Depth", y="Concentration (100m^3)") + theme_classic() + coord_flip()
ggsave("../../figs/temperature-depth.png")
```


```{r Zero inflated data %}
# Column graph
# Column graph
data.ontogeny <- mutate(data.ontogeny, conc.m = conc*1000)
data.ontogeny$stage.r <- factor(data.ontogeny$stage, levels=c("POS","FLE","PRE"))
data.ontogeny$depth.r <- factor(data.ontogeny$depth, levels=c("75","25","0"))
ggplot(data=data.ontogeny, aes(y=conc.m, x=depth.r, group=stage.r, fill=stage.r)) + facet_wrap(~family, scales="free", ncol=4, shrink = TRUE) + stat_summary_bin(fun.y="mean", geom="col", position=position_dodge(width=0.95)) + stat_summary(fun.data = "mean_cl_boot", geom = "linerange",position=position_dodge(width=0.95)) + labs(x="Depth (m)", y=expression("Concentration per 1000 "~m^{3})) + theme_classic() + coord_flip()
ggsave("../../figs/depth-stage-all.png")
```

```{r}
data.length$depth.r <- factor(data.length$depth, levels=c("75","25","0"))
ggplot(aes(y=log(total_length), x=depth.r), data=data.length) + geom_boxplot() + facet_wrap(~family, scales="free", ncol=3) + theme_classic() + coord_flip() +labs(x="Depth (m)", y=expression("Log Length (mm)"))
ggsave("../../figs/length-family.png")
```

# Labrid

```{r}
data.labrid.ontogeny <- filter(data.ontogeny, family=="labridae")
data.labrid.length <- filter(data.length, family=="labridae")
```


## Ontogeny
```{r}
summary(model.ontogeny.labrid.nb <- glm.nb(count ~ feature + feature:depth + 
    feature:stage + depth*stage+ scale(temperature) + offset(log(volume)),data=data.labrid.ontogeny))


#p.resids <- simulateResiduals(model.ontogeny.labrid.p)
#dispersiontest(model.ontogeny.labrid.p)
#testZeroInflation(p.resids)
model.ontogeny.labrid.resids <- simulateResiduals(model.ontogeny.labrid.nb)
testOverdispersion(model.ontogeny.labrid.resids)
testZeroInflation(model.ontogeny.labrid.resids)
```

### Post-hoc
```{r}
Anova(model.ontogeny.labrid.nb, type="II", test="Wald")

data.ontogeny.labrid.posthoc.ovm.stage <- lsmeans(model.ontogeny.labrid.nb, pairwise ~ depth|stage, adjust="Tukey", type="response")
data.ontogeny.labrid.posthoc.ovm.stage
cld(data.ontogeny.labrid.posthoc.ovm.stage, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

data.ontogeny.labrid.posthoc.ovm.depth <- lsmeans(model.ontogeny.labrid.nb, pairwise ~ stage|depth, adjust="Tukey", type="response")
data.ontogeny.labrid.posthoc.ovm.depth
cld(data.ontogeny.labrid.posthoc.ovm.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.labrid.nb, stage ~ depth, type="response")

data.ontogeny.labrid.posthoc.feature.stage <- lsmeans(model.ontogeny.labrid.nb, pairwise ~ stage|feature, adjust="Tukey", type="response")
data.ontogeny.labrid.posthoc.feature.stage
cld(data.ontogeny.labrid.posthoc.feature.stage, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.labrid.nb, stage ~ feature, type="response")

data.ontogeny.labrid.posthoc.feature.depth <- lsmeans(model.ontogeny.labrid.nb, pairwise ~ depth|feature, adjust="Tukey", type="response")
data.ontogeny.labrid.posthoc.feature.depth
cld(data.ontogeny.labrid.posthoc.feature.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.labrid.nb, depth ~ feature, type="response")
```


## Length
```{r}
summary(model.length.labrid.gamma <- glm(total_length ~ feature + depth + temperature + chlorophyll_fluorescence, family = Gamma(link="log"), data=filter(data.length, family=="labridae")))
```

## Length post-hoc analysis
```{r}
Anova(model.length.labrid.gamma, type="II", test="Wald")

model.length.labrid.posthoc <- lsmeans(model.length.labrid.gamma, pairwise ~ depth, adjust="Tukey", type="response")

model.length.labrid.posthoc

model.length.labrid.posthoc.feature <- lsmeans(model.length.labrid.gamma, pairwise ~ feature, adjust="Tukey", type="response")

model.length.labrid.posthoc.feature

cld(model.length.labrid.posthoc, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.length.labrid.gamma, ~ depth, type="response")
```


# Mullid final models

```{r}
data.mullid.ontogeny <- filter(data.ontogeny, family=="mullidae")
data.mullid.length <- filter(data.length, family=="mullidae")
```


# Ontogeny
```{r}
summary(model.ontogeny.mullid.nb <- glm.nb(count ~ offset(log(volume)) + feature  + feature:stage + depth*stage + scale(chlorophyll_fluorescence), data=data.mullid.ontogeny))
drop1(model.ontogeny.mullid.nb)
gof <- 1 - pchisq(summary(model.ontogeny.mullid.nb)$deviance, summary(model.ontogeny.mullid.nb)$df.residual)
#pander(model.ontogeny.mullid.nb)


```

### Post-hoc
```{r}
Anova(model.ontogeny.mullid.nb, type="II", test="Wald")

data.ontogeny.mullid.posthoc.ovm <- lsmeans(model.ontogeny.mullid.nb, pairwise ~ depth|stage, adjust="Tukey", type="response")
data.ontogeny.mullid.posthoc.ovm
cld(data.ontogeny.mullid.posthoc.ovm, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

data.ontogeny.mullid.posthoc.ovm.depth <- lsmeans(model.ontogeny.mullid.nb, pairwise ~ stage|depth, adjust="Tukey", type="response")
data.ontogeny.mullid.posthoc.ovm.depth
cld(data.ontogeny.mullid.posthoc.ovm.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.mullid.nb, stage ~ depth, type="response")

data.ontogeny.mullid.posthoc.feature.stage <- lsmeans(model.ontogeny.mullid.nb, pairwise ~ stage|feature, adjust="Tukey", type="response")
data.ontogeny.mullid.posthoc.feature.stage
cld(data.ontogeny.mullid.posthoc.feature.stage, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.mullid.nb, stage ~ feature, type="response")
```

## Length
```{r}
#summary(model.length.mullid.norm <- glm(total_length ~ feature + depth + scale(temperature), family = gaussian(link="log"), data=data.mullid.length))
summary(model.length.mullid.gamma <- glm(total_length ~ feature + depth + temperature, family = Gamma(link="log"), data=data.mullid.length))
#sjp.glm(model.length.mullid.gamma)
```

## Length post-hoc analysis
```{r}
Anova(model.length.mullid.gamma, type="II", test="Wald")

model.length.mullid.posthoc.depth <- lsmeans(model.length.mullid.gamma, pairwise ~ depth, adjust="Tukey", type="response")
model.length.mullid.posthoc.depth
cld(model.length.mullid.posthoc.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")
lsmip(model.length.mullid.gamma, ~ depth, type="response")
```

Post-hoc analysis for feature
```{r}
model.length.mullid.posthoc.feature <- lsmeans(model.length.mullid.gamma, pairwise ~ feature, adjust="Tukey", type="response")
model.length.mullid.posthoc.feature
cld(model.length.mullid.posthoc.feature, alpha=0.05, Letters=letters, type="response",adjust="Tukey")
lsmip(model.length.mullid.gamma, ~ feature, type="response")
```


# Pomacentridae

```{r}
data.pomacentrid.ontogeny <- filter(data.ontogeny, family=="pomacentridae")
data.pomacentrid.length <- filter(data.length, family=="pomacentridae")
```

## Ontogeny

Seperation in the pomacentrid data, meant we combine the post-flexion and flexion stages


```{r}

data.pomacentrid.ontogeny$stage.posfle <- data.pomacentrid.ontogeny$stage %>% fct_collapse(POSFLE = c("FLE","POS"))
data.pomacentrid.ontogeny$stage.posfle <- factor(data.pomacentrid.ontogeny$stage.posfle, levels = c("PRE", "POSFLE"))

summary(model.ontogeny.pomacentrid.nb <- glm.nb(count ~ offset(log(volume)) + feature * depth * stage.posfle + scale(temperature) + scale(chlorophyll_fluorescence), data=data.pomacentrid.ontogeny))

model.ontogeny.pomacentrid.resids <- simulateResiduals(model.ontogeny.pomacentrid.nb)
testOverdispersion(model.ontogeny.pomacentrid.resids)
testZeroInflation(model.ontogeny.pomacentrid.resids)

#pander(model.ontogeny.pomacentrid.nb)

data.ontogeny.pom.lsmfeature <- lsmeans(model.ontogeny.pomacentrid.nb, ~feature | depth, transform="response")
summary(data.ontogeny.pom.lsmfeature)


```

```{r}
Anova(model.ontogeny.pomacentrid.nb, type="II", test="Wald")

data.ontogeny.pomacentrid.posthoc.depth <- lsmeans(model.ontogeny.pomacentrid.nb, pairwise ~ depth, adjust="Tukey", type="response")
data.ontogeny.pomacentrid.posthoc.depth
cld(data.ontogeny.pomacentrid.posthoc.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

data.ontogeny.pomacentrid.posthoc.ovm.depth <- lsmeans(model.ontogeny.pomacentrid.nb, pairwise ~ depth | stage.posfle, adjust="Tukey", type="response")
data.ontogeny.pomacentrid.posthoc.ovm.depth
cld(data.ontogeny.pomacentrid.posthoc.ovm.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.pomacentrid.nb, depth ~ stage.posfle | feature, type="response")

data.ontogeny.pomacentrid.posthoc.feature.depth <- lsmeans(model.ontogeny.pomacentrid.nb, pairwise ~ depth|feature, adjust="Tukey", type="response")
data.ontogeny.pomacentrid.posthoc.feature.depth
cld(data.ontogeny.pomacentrid.posthoc.feature.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.pomacentrid.nb, depth ~ feature, type="response")

```

## Length
```{r}
#summary(model.length.pom <- glm(total_length ~ feature + depth + dissolved_oxygen, family = gaussian(link="log"), data=data.pomacentrid.length))
summary(model.length.pomacentrid.gamma <- glm(total_length ~ feature + depth + temperature + salinity + dissolved_oxygen, family = Gamma(link="log"), data=data.pomacentrid.length))
```

## Length post-hoc analysis
```{r}
Anova(model.length.pomacentrid.gamma, type="II", test="Wald")

model.length.pomacentrid.posthoc <- lsmeans(model.length.pomacentrid.gamma, pairwise ~ depth, type="response")

model.length.pomacentrid.posthoc

cld(model.length.pomacentrid.posthoc, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.length.pomacentrid.gamma, ~ depth, type="response")
```

# Scaridae

```{r}
data.scarid.ontogeny <- filter(data.ontogeny, family=="scaridae")
data.scarid.length <- filter(data.length, family=="scaridae")
```

## Ontogeny
```{r}
data.scarid.ontogeny$stage.prefle <- data.scarid.ontogeny$stage %>% fct_collapse(POSFLE = c("PRE","FLE"))
#data.scarid.ontogeny$stage.prefle <- factor(data.pomacentrid.ontogeny$stage.posfle, levels = c("PREFLE", "POS"))

summary(model.ontogeny.scarid.nb <- glm.nb(count ~ offset(log(volume)) + feature + depth+ stage + scale(temperature) + scale(dissolved_oxygen)*depth +scale(salinity)*depth, data=data.scarid.ontogeny))

model.ontogeny.scarid.resids <- simulateResiduals(model.ontogeny.scarid.nb)
testOverdispersion(model.ontogeny.scarid.resids)
testZeroInflation(model.ontogeny.scarid.resids)
```

```{r}
Anova(model.ontogeny.scarid.nb, type="II", test="Wald")

data.ontogeny.scarid.posthoc.stage <- lsmeans(model.ontogeny.scarid.nb, pairwise ~ stage, adjust="Tukey", type="response")
data.ontogeny.scarid.posthoc.stage

data.ontogeny.scarid.posthoc.ovm.stage <- lsmeans(model.ontogeny.scarid.nb, pairwise ~ depth | stage, adjust="Tukey", type="response")
data.ontogeny.scarid.posthoc.ovm.stage
cld(data.ontogeny.scarid.posthoc.ovm.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

data.ontogeny.scarid.posthoc.ovm.depth <- lsmeans(model.ontogeny.scarid.nb, pairwise ~ stage | depth, adjust="Tukey", type="response")
data.ontogeny.scarid.posthoc.ovm.depth
cld(data.ontogeny.scarid.posthoc.ovm.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.scarid.nb, ~ depth, type="response")
```


## Length
```{r}
hist(data.scarid.length$total_length)
summary(model.length.scarid.gamma <- glm(total_length ~ depth + temperature + salinity, family = Gamma(link="log"), data=data.scarid.length))
plot(model.length.scarid.gamma)
```

## Length post-hoc analysis
```{r}
Anova(model.length.scarid.gamma, type="II", test="Wald")

model.length.scarid.posthoc <- lsmeans(model.length.scarid.gamma, pairwise ~ depth, adjust="Tukey", type="response")

model.length.scarid.posthoc

cld(model.length.scarid.posthoc, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.length.scarid.gamma, ~ depth, type="response")
```

```{r}
model.length.scarid.posthoc.feature <- lsmeans(model.length.scarid.gamma, pairwise ~ feature, adjust="Tukey", type="response")
model.length.scarid.posthoc.feature
cld(model.length.scarid.posthoc.feature, alpha=0.05, Letters=letters, type="response",adjust="Tukey")
lsmip(model.length.scarid.gamma, ~ feature, type="response")
```


# Scorpaenidae

```{r}
data.scorpaenid.ontogeny <- filter(data.ontogeny, family=="scorpaenidae")
data.scorpaenid.length <- filter(data.length, family=="scorpaenidae")
```

## Ontogeny
```{r}

#data.scorpaenid.ontogeny$stage.prefle <- data.scorpaenid.ontogeny$stage %>% fct_collapse(POSFLE = c("PRE","FLE"))

summary(model.ontogeny.scorpaenid.nb <- glm.nb(count ~ offset(log(volume)) + feature + feature:stage + depth*stage + scale(temperature), data=data.scorpaenid.ontogeny))

model.ontogeny.scorpaenid.resids <- simulateResiduals(model.ontogeny.scorpaenid.nb)
testOverdispersion(model.ontogeny.scorpaenid.resids)
testZeroInflation(model.ontogeny.scorpaenid.resids)
```

### Post-hoc
```{r}
Anova(model.ontogeny.scorpaenid.nb, type="II", test="Wald")

data.ontogeny.scorpaenid.posthoc.ovm <- lsmeans(model.ontogeny.scorpaenid.nb, pairwise ~ depth|stage, adjust="Tukey", type="response")
data.ontogeny.scorpaenid.posthoc.ovm
cld(data.ontogeny.scorpaenid.posthoc.ovm, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

data.ontogeny.scorpaenid.posthoc.ovm.depth <- lsmeans(model.ontogeny.scorpaenid.nb, pairwise ~ stage|depth, adjust="Tukey", type="response")
data.ontogeny.scorpaenid.posthoc.ovm.depth
cld(data.ontogeny.scorpaenid.posthoc.ovm.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.scorpaenid.nb, stage ~ depth, type="response")

data.ontogeny.scorpaenid.posthoc.feature.stage <- lsmeans(model.ontogeny.scorpaenid.nb, pairwise ~ feature | stage, adjust="Tukey", type="response")
data.ontogeny.scorpaenid.posthoc.feature.stage
cld(data.ontogeny.scorpaenid.posthoc.feature.stage, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.scorpaenid.nb, stage ~ feature, type="response")
```


## Length

```{r}
hist(data.scorpaenid.length$total_length)
summary(model.length.scorpaenid.gauss <- glm(total_length ~ feature*depth + temperature + salinity + dissolved_oxygen, family = gaussian(link="log"), data=data.scorpaenid.length))
summary(model.length.scorpaenid.gamma <- glm(total_length ~ feature + depth + salinity, family = Gamma(link="log"), data=data.scorpaenid.length))
plot(model.length.scorpaenid.gamma)
```

## Length post-hoc analysis
```{r}
Anova(model.length.scorpaenid.gamma, type="II", test="Wald")

model.length.scorpaenid.posthoc <- lsmeans(model.length.scorpaenid.gamma, pairwise ~ depth, adjust="Tukey", type="response")

model.length.scorpaenid.posthoc

cld(model.length.scorpaenid.posthoc, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.length.scorpaenid.gamma, ~ depth, type="response")
```

# Serranidae


```{r}
data.serranid.ontogeny <- filter(data.ontogeny, family=="serranidae")
data.serranid.length <- filter(data.length, family=="serranidae")
```

## Ontogeny
```{r}

#data.serranid.ontogeny$stage.prefle <- data.serranid.ontogeny$stage %>% fct_collapse(POSFLE = c("PRE","FLE"))

summary(model.ontogeny.serranid.nb <- glm.nb(count ~ offset(log(volume)) + depth*stage+ scale(dissolved_oxygen), data=data.serranid.ontogeny))

model.ontogeny.serranid.resids <- simulateResiduals(model.ontogeny.serranid.nb)
testOverdispersion(model.ontogeny.serranid.resids)
testZeroInflation(model.ontogeny.serranid.resids)
```

```{r}
Anova(model.ontogeny.serranid.nb, type="II", test="Wald")

data.ontogeny.serranid.posthoc.ovm <- lsmeans(model.ontogeny.serranid.nb, pairwise ~ depth|stage, adjust="Tukey", type="response")
data.ontogeny.serranid.posthoc.ovm
cld(data.ontogeny.serranid.posthoc.ovm, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

data.ontogeny.serranid.posthoc.ovm.depth <- lsmeans(model.ontogeny.serranid.nb, pairwise ~ stage|depth, adjust="Tukey", type="response")
data.ontogeny.serranid.posthoc.ovm.depth
cld(data.ontogeny.serranid.posthoc.ovm.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.serranid.nb, stage ~ depth, type="response")
```


## Length
```{r}
#summary(model.length.serranid.gauss <- glm(total_length ~ feature*depth + temperature + salinity + dissolved_oxygen, family = gaussian(link="log"), data=data.serranid.length))
summary(model.length.serranid.gamma <- glm(total_length ~ feature + depth + temperature + salinity, family = Gamma(link="log"), data=data.serranid.length))
```

## Length post-hoc analysis
```{r}
Anova(model.length.serranid.gamma, type="II", test="Wald")

model.length.serranid.posthoc <- lsmeans(model.length.serranid.gamma, pairwise ~ depth, adjust="Tukey", type="response")

model.length.serranid.posthoc

cld(model.length.serranid.posthoc, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.length.serranid.gamma, ~ depth, type="response")
```

# Synodontid

```{r}
data.synodontid.ontogeny <- filter(data.ontogeny, family=="synodontidae")
data.synodontid.length <- filter(data.length, family=="synodontidae")
```

## Ontogeny
```{r}

#data.synodontid.ontogeny$stage.prefle <- data.synodontid.ontogeny$stage %>% fct_collapse(POSFLE = c("PRE","FLE"))

summary(model.ontogeny.synodontid.nb <- glm.nb(count ~ offset(log(volume)) + feature + feature:depth + feature:stage + depth*stage +scale(temperature) + scale(dissolved_oxygen), data=data.synodontid.ontogeny))

model.ontogeny.synodontid.resids <- simulateResiduals(model.ontogeny.synodontid.nb)
testOverdispersion(model.ontogeny.synodontid.resids)
testZeroInflation(model.ontogeny.synodontid.resids)
```

```{r}
Anova(model.ontogeny.synodontid.nb, type="II", test="Wald")

data.ontogeny.synodontid.posthoc.ovm <- lsmeans(model.ontogeny.synodontid.nb, pairwise ~ depth|stage, adjust="Tukey", type="response")
data.ontogeny.synodontid.posthoc.ovm
cld(data.ontogeny.synodontid.posthoc.ovm, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

data.ontogeny.synodontid.posthoc.ovm.depth <- lsmeans(model.ontogeny.synodontid.nb, pairwise ~ stage|depth, adjust="Tukey", type="response")
data.ontogeny.synodontid.posthoc.ovm.depth
cld(data.ontogeny.synodontid.posthoc.ovm.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.synodontid.nb, stage ~ depth, type="response")
```

Feature post-hoc
```{r}
Anova(model.ontogeny.synodontid.nb, type="II", test="Wald")

data.ontogeny.synodontid.posthoc.feature <- lsmeans(model.ontogeny.synodontid.nb, pairwise ~ stage | feature, adjust="Tukey", type="response")
data.ontogeny.synodontid.posthoc.feature
cld(data.ontogeny.synodontid.posthoc.feature, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.synodontid.nb, stage ~ feature, type="response")

data.ontogeny.synodontid.posthoc.feature.depth <- lsmeans(model.ontogeny.synodontid.nb, pairwise ~ feature|depth, adjust="Tukey", type="response")
data.ontogeny.synodontid.posthoc.feature.depth
cld(data.ontogeny.synodontid.posthoc.feature.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.synodontid.nb, depth ~ feature, type="response")
```

## Length
```{r}
#summary(model.length.synodontid.gauss <- glm(total_length ~ feature*depth + temperature + salinity + dissolved_oxygen, family = gaussian(link="log"), data=data.synodontid.length))
summary(model.length.synodontid.gamma <- glm(total_length ~ feature + depth + dissolved_oxygen, family = Gamma(link="log"), data=data.synodontid.length), type="response")
```
## Length post-hoc analysis
```{r}
Anova(model.length.synodontid.gamma, type="II", test="Wald")

model.length.synodontid.posthoc <- lsmeans(model.length.synodontid.gamma, pairwise ~ depth, adjust="Tukey", type="response")

model.length.synodontid.posthoc

cld(model.length.synodontid.posthoc, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.length.synodontid.gamma, ~ depth, type="response")
```

```{r}
panderOptions('table.alignment.default', function(model.ontogeny.labrid.nb)
    ifelse(sapply(model.ontogeny.labrid.nb, is.numeric), 'right', 'left'))
panderOptions('table.split.table', Inf)
panderOptions('big.mark', ",")
panderOptions('keep.trailing.zeros', TRUE)
panderOptions('table.style','rmarkdown')
panderOptions('table.emphasize.rownames',FALSE)
panderOptions('table.alignment.rownames','left')
panderOptions('round',3)
pander(model.ontogeny.labrid.nb)
```

```{r}
sjt.glm(model.ontogeny.synodontid.nb,file="table.html")
```

Stargazer output
```{r}
stargazer(model.length.labrid.gamma,model.length.mullid.gamma, model.length.pomacentrid.gamma,model.length.scarid.gamma, model.length.scorpaenid.gamma, model.length.serranid.gamma, model.length.synodontid.gamma, 
          star.cutoffs = c(0.05,0.01,0.001),
          dep.var.labels = "Length (mm)",
          covariate.labels = c("Feature (Eddy)", "Depth (25 m)", "Depth (75 m)", "Temperature", "Chlorophyll", "Salinity", "Dissolved Oxygen"),
          model.numbers = FALSE,
          column.labels = c("Labridae", "Mullidae", "Pomacentridae", "Scaridae", "Scorpaenidae", "Serranidae","Synodontidae"),
          omit.stat = c("aic","ll"),
          type='text')

stargazer(model.ontogeny.labrid.nb,model.ontogeny.mullid.nb, model.ontogeny.scorpaenid.nb, model.ontogeny.serranid.nb, model.ontogeny.synodontid.nb,
          star.cutoffs = c(0.05,0.01,0.001),
          dep.var.labels = "Length (mm)",
          covariate.labels = c("Feature(Eddy)", "Depth(25)", "Depth(75)","Stage(FLE)", "Stage(POS)", "Temperature","Feature(Eddy):Depth(25)","Feature(Eddy):Depth(75)", "Chlorophyll","Feature(Eddy):Stage(FLE)","Feature(Eddy):Stage(POS)", "Dissolved Oxygen","Depth(25):Stage(FLE)","Depth(25):Stage(POS)","Depth(75):Stage(FLE)","Depth(75):Stage(POS)","Depth(25):Stage(FLE)","Depth(25):Stage(POS)","Depth(75):Stage(FLE)","Depth(75):Stage(POS)"),
          model.numbers = FALSE,
          column.labels = c("Labridae", "Mullidae", "Scorpaenidae", "Serranidae","Synodontidae"),
          omit.stat = c("aic","ll"),
          type='text')

stargazer(model.ontogeny.pomacentrid.nb, 
          star.cutoffs = c(0.05,0.01,0.001),
          dep.var.labels = "Concentration (m3)",
          covariate.labels = c("Feature(Eddy)", "Depth(25)", "Depth(75)","Stage(FLEPOS)", "Temperature","Chlorophyll","Feature(Eddy):Depth(25)","Feature(Eddy):Depth(75)", "Feature(Eddy):Stage(FLEPOS)", "Depth(25):Stage(FLEPOS)","Depth(75):Stage(FLEPOS)","Feature(Eddy):Depth(25):Stage(FLEPOS)","Feature(Eddy):Depth(75):Stage(FLEPOS)"),
          omit.stat = c("aic","ll"),
          type='html')
```


