---
title: "Empirical analysis"
output:
  word_document: default
  pdf_document: default
  html_notebook: default
---

# The analysis of my empirical chapter - ORLE methods 

```{r Packages, include=FALSE}
library(tidyverse)
library(corrr)
library(MASS)
library(lsmeans)
library(lme4)
library(pscl)
library(boot)
library(DHARMa)
library(AER)
library(multcomp)
library(multcompView)
library(stargazer)
library(cowplot)
```

```{r Load data, include=FALSE}
load(file="length.RData")
load(file="ontogeny.RData")
load(file="tow.RData")
source("empirical-functions.R")

data.ontogeny$stage <- factor(data.ontogeny$stage, levels=c("PRE","FLE","POS"))
```




# Exploratory analysis

## Check for correlations. DO and Chloro look highly correlated - so only include one in any model
```{r}
data.environment <- data.ontogeny %>% ungroup() %>% dplyr::select(temperature, salinity, chlorophyll_fluorescence, dissolved_oxygen) 
correlate(data.environment)
```

## What does the data look like?

Looks like poisson or negative binomial distributions - with perhaps a tendency to be zero-inflated? Some have a lot of zeros in the output.

```{r}
ggplot(data=data.ontogeny, aes(conc)) + geom_histogram() + facet_wrap(~ family, scales="free") + labs(x="count")
```

```{r}
#ggplot(data=data.tow, aes(temperature~depth)) + geom_bar()
```

```{r}



```

```{r Explore ontogeny data}
#data.ontogeny.summary <- na.omit(data.ontogeny)
data.ontogeny.interaction_ds <-  summarize(group_by(na.omit(data.ontogeny), family, depth,stage), conc.mean = mean(conc), conc.se = sd(conc)/n())
data.ontogeny.interaction_ds.abund <-  summarize(group_by(na.omit(data.ontogeny), family, depth,stage), conc.mean = mean(count), conc.se = sd(count)/n())
data.ontogeny.interaction_fds <-  summarize(group_by(na.omit(data.ontogeny), feature, family, depth,stage), conc.mean = mean(conc), conc.se = sd(conc)/n())
data.ontogeny.depth <-  summarize(group_by(na.omit(data.ontogeny), family, depth), conc.mean = mean(conc), conc.se = sd(conc)/n())
data.ontogeny.stage <-  summarize(group_by(na.omit(data.ontogeny), family, stage), conc.mean = mean(conc), conc.se = sd(conc)/n())
data.ontogeny.feature <-  summarize(group_by(na.omit(data.ontogeny), family, feature), conc.mean = mean(conc), conc.se = sd(conc)/n())

ggplot(aes(y=conc.mean, x=depth, group=stage, colour=stage), data=data.ontogeny.interaction_ds) + geom_point() + geom_line() + geom_errorbar(aes(ymin=conc.mean-conc.se,ymax=conc.mean+conc.se),width=.1) + facet_wrap(~family, scales = "free")

ggplot(aes(y=conc.mean, x=depth, group=family), data=data.ontogeny.depth) + geom_point(aes(colour=family)) + geom_line(aes(colour=family))
ggplot(aes(y=conc.mean, x=stage, group=family), data=data.ontogeny.stage) + geom_point(aes(group=family, colour=family)) + geom_line(aes(colour=family))
ggplot(aes(y=conc.mean, x=feature, group=family), data=data.ontogeny.feature) + geom_point(aes(group=family, colour=family)) + geom_line(aes(colour=family))

ggplot(aes(y=conc.mean, x=depth, group=stage, colour=stage), data=data.ontogeny.interaction_fds) + geom_point() + geom_line() + facet_grid(feature ~ family, scales = "free")

ggplot(data=na.omit(data.ontogeny), aes(y=conc, x=temperature)) + geom_jitter(aes(colour = family)) + stat_smooth(aes(colour=family), method="lm", se=FALSE)
ggplot(data=na.omit(data.ontogeny), aes(y=conc, x=salinity)) + geom_jitter(aes(colour = family)) + stat_smooth(aes(group=family, colour=family),method="lm",se=FALSE)
ggplot(data=na.omit(data.ontogeny), aes(y=conc, x=chlorophyll_fluorescence)) + geom_jitter(aes(colour = family)) + stat_smooth(aes(colour=family), method="lm",se=FALSE)
ggplot(data=na.omit(data.ontogeny), aes(y=conc, x=dissolved_oxygen)) + geom_jitter(aes(colour = family)) + stat_smooth(aes(group=family,colour=family), method="glm",se=FALSE)

```

Environmental data
```{r}
# Column graph
#data.ontogeny <- mutate(data.ontogeny, conc.m = conc*1000)
#data.ontogeny$stage.r <- factor(data.ontogeny$stage, levels=c("POS","FLE","PRE"))
#data.ontogeny$depth.r <- factor(data.ontogeny$depth, levels=c("75","25","0"))
pd <- position_dodge(0.1)

temp.data <- data.ontogeny %>% filter(temperature != "NA") %>% group_by(feature,depth) %>% summarise(temp.mean = mean(temperature), temp.sd = sd(temperature))
temp.plot <- ggplot(data=temp.data, aes(y=temp.mean, x=rev(depth), group = feature, colour=feature)) + labs(x="Depth", y="Temperature (Â°C)") + geom_errorbar(aes(ymin=temp.mean-temp.sd, ymax=temp.mean+temp.sd),width=.1,position=pd,size=1) + geom_line(position=pd, size=1)  + coord_flip() + scale_x_discrete(labels=c("Deep","Middle","Surface"))+scale_colour_manual(values=pal) + theme_cowplot(font_size=12,font_family="sans")

salt.data <- data.ontogeny %>% filter(salinity != "NA") %>% group_by(feature, depth) %>% summarise(salt.mean = mean(salinity), salt.sd = sd(salinity))
salt.plot <- ggplot(data=salt.data, aes(y=salt.mean, x=rev(depth), group = feature, colour=feature)) + labs(x="", y="Salinity (PSU)") +  geom_errorbar(aes(ymin=salt.mean-salt.sd, ymax=salt.mean+salt.sd),width=.1,position=pd, size=1) + geom_line(position=pd,size=1)  + coord_flip() + scale_x_discrete(labels=element_blank()) + scale_colour_manual(values=pal)+ theme_cowplot(font_size=12,font_family = "sans") 


do.data <- data.ontogeny %>% filter(dissolved_oxygen != "NA") %>% group_by(feature, depth) %>% summarise(do.mean = mean(dissolved_oxygen), do.sd = sd(dissolved_oxygen))
do.plot <- ggplot(data=do.data, aes(y=do.mean, x=rev(depth), group = feature, colour=feature)) + labs(x="", y="Dissolved oxygen (mg/L)")  + geom_errorbar(aes(ymin=do.mean-do.sd, ymax=do.mean+do.sd),width=.1,position=pd, size=1) + geom_line(position=pd, size=1) + coord_flip()+ scale_x_discrete(labels=c("Deep","Middle","Surface")) +scale_colour_manual(values=pal)+ theme_cowplot(font_size=12,font_family = "sans")

chloro.data <- data.ontogeny %>% filter(chlorophyll_fluorescence != "NA") %>% group_by(feature, depth) %>% summarise(chloro.mean = mean(chlorophyll_fluorescence), chloro.sd = sd(chlorophyll_fluorescence))
chloro.plot <- ggplot(data=chloro.data, aes(y=chloro.mean, x=rev(depth), colour=feature, group = feature)) + labs(x="", y="Fluorescence (RFU)") + geom_errorbar(aes(ymin=chloro.mean-chloro.sd, ymax=chloro.mean+chloro.sd),width=.1,position=pd, size=1) + geom_line(position=pd, size=1)  + coord_flip() + scale_x_discrete(labels=element_blank()) + scale_colour_manual(values=pal,name="Feature")+ theme_cowplot(font_size=12,font_family = "sans") +theme(legend.position="right") 
  
legend <- get_legend(chloro.plot)

env.plot <- plot_grid(temp.plot+ theme(legend.position="none"),salt.plot+ theme(legend.position="none"),do.plot + theme(legend.position="none"), chloro.plot+ theme(legend.position="none"), ncol=2, nrow=2, labels="AUTO", rel_widths=c(1.1,1,1,1))
p <- plot_grid( env.plot, legend,rel_widths = c(3,.3))
save_plot("../../figs/environment.png", p, ncol=2, nrow= 2)

```


```{r Zero inflated data %}
# Column graph
data.ontogeny <- mutate(data.ontogeny, conc.m = conc*1000)
data.ontogeny$stage.r <- factor(data.ontogeny$stage, levels=c("POS","FLE","PRE"))
data.ontogeny$depth.r <- factor(data.ontogeny$depth, levels=c("75","25","0"))
ggplot(data=data.ontogeny, aes(y=conc.m, x=depth.r, group=stage.r, fill=stage.r)) + facet_wrap(~family, scales="free", ncol=4, shrink = TRUE) + stat_summary_bin(fun.y="mean", geom="col", position=position_dodge(width=0.95)) + stat_summary(fun.data = "mean_cl_boot", geom = "linerange",position=position_dodge(width=0.95)) + labs(x="Depth (m)", y=expression("Concentration per 1000 "~m^{3})) + theme_classic() + coord_flip()
ggsave("../../figs/depth-stage-all-col.png")
```


```{r Zero inflated data point %}
# Column graph
# Column graph
data.ontogeny <- mutate(data.ontogeny, conc.m = conc*1000)
data.ontogeny$stage.r <- factor(data.ontogeny$stage, levels=c("PRE","FLE","POS"))
data.ontogeny$depth.r <- factor(data.ontogeny$depth, levels=c("75","25","0"))
dat_text <- data.frame(
  family = c("labridae","mullidae","scorpaenidae","serranidae","synodontidae"),
  stage.r = c("PRE","PRE","PRE","PRE","PRE"),
  x     = c(3.25, 3.25, 3.25,3.25,3.25),
  y     = c(21.25, 5.15, 2.3,18.5,2.6)
)
p <- ggplot(data=data.ontogeny, aes(y=conc.m, x=depth.r, group=stage.r, color=stage.r)) + facet_wrap(~family, scales="free", ncol=4, shrink = TRUE) + stat_summary_bin(fun.y="mean", geom="line", position=position_dodge(width=0.5), show.legend=FALSE) + stat_summary_bin(fun.y="mean", geom="point", position=position_dodge(width=0.5),size=2) + stat_summary(fun.data = "mean_cl_boot", geom = "linerange",position=position_dodge(width=0.5),show.legend = FALSE) + labs(x="Depth (m)", y=expression("Concentration per 1000 "~m^{3})) + theme_bw() + coord_flip() + scale_color_discrete(name="", labels=c("Preflexion","Flexion","Postflexion")) + theme(legend.position = c(0.85,0.15), legend.justification = c(0.3,0)) 
p <- p + geom_text(
  data    = dat_text,
  mapping = aes(x = x, y = y, label = "*", colour=NA),
  size = 8,
  show.legend = FALSE
)
ggsave("../../figs/depth-stage-all-point.png",plot=p, width=6.46, height=3.93)
```

```{r}
data.ontogeny <- mutate(data.ontogeny, conc.m = conc*1000)
data.ontogeny$stage.r <- factor(data.ontogeny$stage, levels=c("PRE","FLE","POS"))
data.ontogeny$depth.r <- factor(data.ontogeny$depth, levels=c("75","25","0"))
ggplot(data=data.ontogeny, aes(y=log(conc.m), x=depth.r, group=stage.r, color=stage.r)) + facet_wrap(~feature+family,ncol=7, shrink = TRUE) + stat_summary_bin(fun.y="mean", geom="line", position=position_dodge(width=0.5), show.legend=FALSE) + stat_summary_bin(fun.y="mean", geom="point", position=position_dodge(width=0.5),size=1) + stat_summary(fun.data = "mean_cl_boot", geom = "linerange",position=position_dodge(width=0.5),show.legend = FALSE) + labs(x="Depth (m)", y=expression("Log concentration per 1000 "~m^{3})) + theme_classic() + coord_flip() + scale_color_discrete(name="", labels=c("Preflexion","Flexion","Postflexion")) + theme(legend.position = "bottom")
ggsave("../../figs/depth-stage-feature.png")
```



```{r}
data.length$depth.r <- factor(data.length$depth, levels=c("75","25","0"))
data.length$family.label <- factor(data.length$family,labels=c("Labridae*","Mullidae*","Pomacentridae*","Scaridae*","Scorpaenidae*","Serranidae*","Synodontidae"))
dat_text <- data.frame(
  family = c("labridae","mullidae","pomacentridae","scaridae","scorpaenidae","serranidae"),
  x = c(3.15, 3.15, 3.15, 3.15, 3.15, 3.15),
  y = c(6.10,10,4.3,6.4,5.7,4.6)
)

# p <- ggplot(aes(y=standard_length, x=depth.r, group=1), data=data.length)+stat_summary_bin(fun.y="mean", geom="point") + stat_summary(fun.data = "mean_cl_boot", geom = "linerange",show.legend = FALSE) +stat_summary(fun.y="mean", geom="line")+ facet_wrap(~family.label,ncol=4, scales = "free") + coord_flip() +labs(x="Depth (m)", y=expression("Length (mm)"))

p <- ggplot(aes(y=standard_length, x=depth.r), data=filter(data.length, standard_length < 30)) + geom_boxplot()+ facet_wrap(~family.label,ncol=4, scales = "free") + coord_flip() +labs(x="Depth (m)", y=expression("Length (mm)")) + theme_cowplot(font_size=12,font_family = "sans")

# p <- p + geom_text(
#   data    = dat_text,
#   mapping = aes(x = x, y = y, label = "*"),
#   size = 8
# )
ggsave("../../figs/length-depth-family.png", plot=p, width=7.29, height=4.51, units=c("in"))
```

```{r}
pal <- canva_pal("Fresh and energetic")(4)

data.length$depth.r <- factor(data.length$depth, levels=c("75","25","0"))
data.length$family.label <- factor(data.length$family,labels=c("Labridae*","Mullidae*","Pomacentridae*","Scaridae","Scorpaenidae*","Serranidae*","Synodontidae*"))
dat_text <- data.frame(
  family = c("labridae","mullidae","pomacentridae","scorpaenidae","serranidae","synodontidae"),
  x = c(2.15, 2.15, 2.15, 2.15, 2.15, 2.15),
  y = c(12,12,12,12,12,12)
)
p<- ggplot(aes(y=standard_length, x=feature, fill=feature), data=data.length) +stat_summary_bin(fun.y="mean", geom="bar") + stat_summary(fun.data = "mean_cl_boot", geom = "linerange",show.legend = FALSE) + facet_wrap(~family.label, ncol=4) + labs(x="", y=expression("Length (mm)")) + scale_fill_manual(values=pal,name="Feature") + theme_cowplot(font_size=12,font_family = "sans") + theme(legend.position = c(0.95, 0.15), legend.justification = c(1, 0), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank())
# p <- p + geom_text(
#   data    = dat_text,
#   mapping = aes(x = x, y = y, label = "*"),
#   size = 8,
#   show.legend = FALSE
# )
cowplot::ggsave("../../figs/length-family-feature.png", plot=p, width=6.46, height=3.93, units=c("in"))
```


```{r}
data.ontogeny$depth.r <- factor(data.ontogeny$depth, levels=c("75","25","0"))
data.ontogeny <- mutate(data.ontogeny, conc.t = conc*1000)
ggplot(aes(y=conc, x=depth.r), data=data.ontogeny) +stat_summary_bin(fun.y="mean", geom="bar") + stat_summary(fun.data = "mean_cl_boot", geom = "linerange",show.legend = FALSE) + facet_wrap(~family, ncol=4) + theme_bw() + labs(x="Feature", y=expression("Length (mm)")) + coord_flip()
ggsave("../../figs/depth-abundance.png")
```

Abundance and feature
```{r}
pal <- canva_pal("Fresh and energetic")(4)

#data.ontogeny$depth.r <- factor(data.ontogeny$depth, levels=c("75","25","0"))
data.ontogeny <- mutate(data.ontogeny, conc.t = conc*1000)
data.ontogeny$family.label <- factor(data.ontogeny$family,labels=c("Labridae*","Mullidae*","Pomacentridae","Scaridae*","Scorpaenidae","Serranidae","Synodontidae"))
dat_text <- data.frame(
  family = c("labridae","mullidae","pomacentridae","scaridae","scorpaenidae","serranidae","synodontidae"),
  x = c(2.25, 2.25, 2.25, 2.25, 2.25, 2.25,2.25),
  y = c(0.0105,0.0105,0.0105,0.0105,0.0105,0.0105,0.0105)
)

p<- ggplot(aes(y=conc.t, x=feature, fill=feature), data=data.ontogeny) +stat_summary_bin(fun.y="mean", geom="bar") + stat_summary(fun.data = "mean_cl_boot", geom = "linerange",show.legend = FALSE) + facet_wrap(~family.label, ncol=4, scales = "free") + labs(x="", y=expression("Concentration per 1000"~m^{3})) + scale_fill_manual(values=pal,name="Feature")  + theme_cowplot(font_size=12,font_family = "sans") +theme(legend.position = c(0.95, 0.15), legend.justification = c(1, 0), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank())
cowplot::ggsave("../../figs/feature-abundance.png", plot=p, width=7, height=4, units=c("in"))
```

```{r}

pal <- canva_pal("Fresh and energetic")(4)

data.ontogeny$family.label <- factor(data.ontogeny$family, labels=c("Labridae*","Mullidae*","Pomacentridae","Scaridae","Scorpaenidae*","Serranidae*","Synodontidae*"))

data.ontogeny$stage.label <- factor(data.ontogeny$stage, labels=c("Preflexion","Flexion","Postflexion"))

data.ontogeny.weighted.total <- data.ontogeny %>% filter(conc != 'NA') %>% mutate(depth.w = if_else(depth==0,5,if_else(depth==25,28,75.5))) %>% group_by(family.label, stage.label, depth.w) %>% summarise(total= sum(count),conc.sum = sum(conc)) %>% mutate(prop = conc.sum / (sum(conc.sum)+0.000001)) %>% mutate(depth.z = depth.w*prop) %>% group_by(family.label, stage.label) %>% summarise(depth.weighted = sum(depth.z))

data.ontogeny.weighted.totalcount <- data.ontogeny %>% mutate(depth.w = if_else(depth==0,5,if_else(depth==25,28,75.5))) %>% group_by(family.label, stage.label, depth.w) %>% summarise(total= sum(count)) %>% mutate(prop = total / (sum(total)+0.000001)) %>% mutate(depth.z = depth.w*prop) %>% group_by(family.label, stage.label) %>% summarise(depth.weighted = sum(depth.z))

data.ontogeny.weighted.prop <- data.ontogeny %>% mutate(depth.w = if_else(depth==0,5,if_else(depth==25,28,75.5))) %>% group_by(family.label, stage.label, depth.w) %>% summarise(total= sum(count)) %>% mutate(prop = total / (sum(total)+0.000001))

plot <- ggplot(aes(x=stage.label,y=depth.weighted, colour=family.label, group=family.label),data=data.ontogeny.weighted.total)  + scale_y_reverse() + geom_line(size=1.5, alpha=0.75) + scale_colour_brewer(name="Family", palette = "Set2") + labs(x="Stage",y="Depth (m)")  + theme_cowplot(font_size=12,font_family = "sans")

plot2 <- ggplot(aes(x=stage.label,y=depth.weighted, colour=family.label, group=family.label),data=data.ontogeny.weighted.totalcount)  + scale_y_reverse() + geom_line(size=1.5, alpha=0.75) + scale_colour_brewer(name="Family", palette = "Set2") + labs(x="Stage",y="Depth (m)") + theme_cowplot(font_size=12,font_family = "sans")

both <- plot_grid(plot,plot2)
#+ geom_ribbon(aes(ymin=depth.weighted-depth.sd, ymax=depth.weighted+depth.sd, fill=family.label), alpha=0.05)
ggsave("../../figs/weighted-depth.png", plot, width=8, height=5, scale=2.5, units="cm")

data.ontogeny.weighted.station <- data.ontogeny %>% filter(conc != 'NA') %>% mutate(depth.w = if_else(depth==0,5,if_else(depth==25,28,75.5))) %>% group_by(site, family.label, stage.label, depth.w) %>% summarise(count= sum(count),conc.sum = sum(conc)) %>% mutate(prop = conc.sum / (sum(conc.sum)+0.000001)) %>% mutate(depth.z = depth.w*prop) %>% group_by(site, family.label, stage.label) %>% summarise(depth.weighted = sum(depth.z))
data.ontogeny.weighted.station$depth.scale <- data.ontogeny.weighted.station$depth.weighted


data.ontogeny.prop <- data.ontogeny %>% filter(conc != 'NA') %>% group_by(family.label, stage.label, depth) %>% summarise(count= sum(count),conc.sum = sum(conc)) %>% mutate(prop = count / (sum(count)+0.000001))

data.ontogeny.prop$depth.scale <- as.numeric(data.ontogeny.prop$depth)
data.ontogeny.prop <- data.ontogeny.prop %>% mutate(depth.scale = if_else(depth.scale==1,2.5,if_else(depth.scale==2,28,75.5)))

data.ontogeny.weighted.total$depth.scale <- data.ontogeny.weighted.total$depth.weighted

violinplot <- ggplot(aes(x=stage.label,y=depth.scale, weight=prop, fill=stage.label), data=data.ontogeny.prop)  + scale_y_reverse(limits=c(100,0)) + geom_violin(adjust = .85, trim=FALSE) + facet_wrap(~ family.label, ncol=4)+theme_cowplot(font_size=12,font_family = "sans") +theme(legend.position = c(0.95, 0.15), legend.justification = c(1, 0), axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()) + labs(y="Depth (m)", x=element_blank())  + scale_fill_manual(values=pal,name="Stage") + geom_line(data=data.ontogeny.weighted.total, inherit.aes = FALSE, aes(x=stage.label,y=depth.scale, group=family.label)) + geom_point(data=data.ontogeny.weighted.total, inherit.aes = FALSE, aes(x=stage.label,y=depth.scale)) #ggplot(aes(x=stage.label,y=depth.weighted, colour=family.label, group=family.label),data=data.ontogeny.weighted.total)  

# + stat_summary(fun.y=mean, geom="point", size=2, color="red", data=data.ontogeny.weighted.station, inherit.aes = FALSE,aes(x=stage.label,y=depth.scale))


ggsave("../../figs/stages-by-family.png", violinplot, width=8, height=6)


```

```{r}
ggplot(aes(y=conc.m, x=temperature), data=data.ontogeny)+ geom_point()+theme_bw() +labs(x="Temperature (C)", y=expression("Concentration 1000m  "~m^{3})) + facet_wrap(~family, scales="free",ncol=4) + geom_smooth(data=filter(data.ontogeny, family == "labridae" | family == 'scaridae' | family == 'scorpaenidae' | family=="synodontidae"), inherit.aes = FALSE, aes(y=count, x=temperature), method=MASS::glm.nb)
ggsave("../../figs/conc-temp-family.png")

ggplot(aes(y=conc.m, x=salinity), data=data.ontogeny)+ geom_point()+theme_bw() +labs(x="Salinity (PSI)", y=expression("Concentration 1000m  "~m^{3})) + facet_wrap(~family, scales="free",ncol=4) + geom_smooth(data=filter(data.ontogeny, family == "scaridae"),  method=MASS::glm.nb, method.args = list(offset(log(data.ontogeny$volume))))
ggsave("../../figs/conc-salt-family.png")

ggplot(aes(y=conc.m, x=dissolved_oxygen), data=data.ontogeny)+ geom_point()+theme_bw() +labs(x="Dissolved Oxygen (mg/L)", y=expression("Concentration 1000m  "~m^{3})) + facet_wrap(~family, scales="free",ncol=4) + geom_smooth(data=filter(data.ontogeny, family == 'labridae'), method=MASS::glm.nb, method.args = list(offset(log(data.ontogeny$volume))))
ggsave("../../figs/conc-doxy-family.png")

ggplot(aes(y=count, x=chlorophyll_fluorescence), data=data.ontogeny)+ geom_point()+theme_bw() +labs(x="Chlorophyll (Volts)", y=expression("Concentration 1000m  "~m^{3})) + facet_wrap(~family, scales="free",ncol=4) + geom_smooth(data=filter(data.ontogeny, family == 'pomacentridae' | family == 'mullidae'), method=MASS::glm.nb, method.args = list(offset(log(data.ontogeny$volume))))
ggsave("../../figs/conc-chloro-family.png")
```


```{r}
ggplot(aes(y=standard_length, x=temperature), data=data.length)+ geom_point()+theme_bw() +labs(x="Temperature (C)", y=expression("Standard length (mm)")) + facet_wrap(~family, scales="free",ncol=4) + geom_smooth(data=filter(data.length, family == "labridae" | family == 'mullidae' | family == 'pomacentridae' | family=="serranidae"),method="lm")
ggsave("../../figs/length-temp-family.png")

ggplot(aes(y=standard_length, x=salinity), data=data.length)+ geom_point()+theme_bw() +labs(x="Salinity (PSI)", y=expression("Standard length (mm)")) + facet_wrap(~family, scales="free",ncol=4) + geom_smooth(data=filter(data.length, family == "scaridae" | family == 'pomacentridae' | family == 'scorpaenidae'), method="glm", method.args = list(family="Gamma"))
ggsave("../../figs/length-salt-family.png")

ggplot(aes(y=standard_length, x=dissolved_oxygen), data=data.length)+ geom_point()+theme_bw() +labs(x="Dissolved Oxygen (mg/L)", y=expression("Standard length (mm)")) + facet_wrap(~family, scales="free",ncol=4) + geom_smooth(data=filter(data.length, family == 'pomacentridae'), method="glm", method.args = list(family="Gamma"))
ggsave("../../figs/length-doxy-family.png")

ggplot(aes(y=standard_length, x=chlorophyll_fluorescence), data=data.length)+ geom_point()+theme_bw() +labs(x="Chlorophyll (Volts)", y=expression("Standard length (mm)")) + facet_wrap(~family, scales="free",ncol=4) + geom_smooth(data=filter(data.length, family == 'labridae'), method="glm", method.args = list(family="Gamma"))
ggsave("../../figs/length-chloro-family.png")
```


# Labrid

```{r}
data.labrid.ontogeny <- filter(data.ontogeny, family=="labridae")
data.labrid.length <- filter(data.length, family=="labridae")
```


## Ontogeny
```{r}
summary(model.ontogeny.labrid.nb <- glm.nb(count ~ feature + feature:depth + 
    feature:stage + depth*stage+ scale(temperature) + offset(log(volume)),data=data.labrid.ontogeny))


#p.resids <- simulateResiduals(model.ontogeny.labrid.p)
#dispersiontest(model.ontogeny.labrid.p)
#testZeroInflation(p.resids)
model.ontogeny.labrid.resids <- simulateResiduals(model.ontogeny.labrid.nb)
testOverdispersion(model.ontogeny.labrid.resids)
testZeroInflation(model.ontogeny.labrid.resids)
```

### Post-hoc
```{r}
Anova(model.ontogeny.labrid.nb, type="III", test="Wald")

data.ontogeny.labrid.posthoc.ovm.stage <- lsmeans::lsmeans(model.ontogeny.labrid.nb, pairwise ~ depth|stage, adjust="Tukey", type="response")
data.ontogeny.labrid.posthoc.ovm.stage
cld(data.ontogeny.labrid.posthoc.ovm.stage, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

data.ontogeny.labrid.posthoc.ovm.depth <- lsmeans::lsmeans(model.ontogeny.labrid.nb, pairwise ~ stage|depth, adjust="Tukey", type="response")
data.ontogeny.labrid.posthoc.ovm.depth
cld(data.ontogeny.labrid.posthoc.ovm.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.labrid.nb, stage ~ depth, type="response")

data.ontogeny.labrid.posthoc.feature.stage <- lsmeans::lsmeans(model.ontogeny.labrid.nb, pairwise ~ stage|feature, adjust="Tukey", type="response")
data.ontogeny.labrid.posthoc.feature.stage
cld(data.ontogeny.labrid.posthoc.feature.stage, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.labrid.nb, stage ~ feature, type="response")

data.ontogeny.labrid.posthoc.feature.depth <- lsmeans::lsmeans(model.ontogeny.labrid.nb, pairwise ~ depth|feature, adjust="Tukey", type="response")
data.ontogeny.labrid.posthoc.feature.depth
cld(data.ontogeny.labrid.posthoc.feature.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.labrid.nb, depth ~ feature, type="response")
```


## Length
```{r}
summary(model.length.labrid.gamma <- glm(standard_length ~ feature + depth + temperature + chlorophyll_fluorescence, family = Gamma, data=filter(data.length, family == "labridae")))

summary(model.length.labrid.lm <- lm(standard_length ~ feature * depth + temperature + chlorophyll_fluorescence + salinity, data=filter(data.length, family == "labridae" & standard_length < 30)))
```

## Length post-hoc analysis
```{r}
Anova(model.length.labrid.gamma, type="II", test="Wald")

model.length.labrid.posthoc <- lsmeans::lsmeans(model.length.labrid.gamma, pairwise ~ depth, adjust="Tukey", type="response")

model.length.labrid.posthoc

model.length.labrid.posthoc.feature <- lsmeans::lsmeans(model.length.labrid.gamma, pairwise ~ feature, adjust="Tukey", type="response")

model.length.labrid.posthoc.feature

cld(model.length.labrid.posthoc, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.length.labrid.gamma, ~ depth, type="response")
```


# Mullid final models

```{r}
data.mullid.ontogeny <- filter(data.ontogeny, family=="mullidae")
data.mullid.length <- filter(data.length, family=="mullidae")
```


# Ontogeny
```{r}
summary(model.ontogeny.mullid.nb <- glm.nb(count ~ offset(log(volume)) + feature  + feature:stage + depth*stage + scale(chlorophyll_fluorescence), data=data.mullid.ontogeny))
drop1(model.ontogeny.mullid.nb)
gof <- 1 - pchisq(summary(model.ontogeny.mullid.nb)$deviance, summary(model.ontogeny.mullid.nb)$df.residual)
#pander(model.ontogeny.mullid.nb)


```

### Post-hoc
```{r}
Anova(model.ontogeny.mullid.nb, type="III", test="Wald")

data.ontogeny.mullid.posthoc.ovm <- lsmeans::lsmeans(model.ontogeny.mullid.nb, pairwise ~ depth|stage, adjust="Tukey", type="response")
data.ontogeny.mullid.posthoc.ovm
cld(data.ontogeny.mullid.posthoc.ovm, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

data.ontogeny.mullid.posthoc.ovm.depth <- lsmeans::lsmeans(model.ontogeny.mullid.nb, pairwise ~ stage|depth, adjust="Tukey", type="response")
data.ontogeny.mullid.posthoc.ovm.depth
cld(data.ontogeny.mullid.posthoc.ovm.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.mullid.nb, stage ~ depth, type="response")

data.ontogeny.mullid.posthoc.feature.stage <- lsmeans::lsmeans(model.ontogeny.mullid.nb, pairwise ~ stage|feature, adjust="Tukey", type="response")
data.ontogeny.mullid.posthoc.feature.stage
cld(data.ontogeny.mullid.posthoc.feature.stage, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

data.ontogeny.mullid.posthoc.feature.stage <- lsmeans::lsmeans(model.ontogeny.mullid.nb, pairwise ~ feature|stage, adjust="Tukey", type="response")
data.ontogeny.mullid.posthoc.feature.stage
cld(data.ontogeny.mullid.posthoc.feature.stage, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.mullid.nb, stage ~ feature, type="response")
```

## Length
```{r}
summary(model.length.mullid.gamma <- glm(standard_length ~ feature + depth + temperature + dissolved_oxygen, family = Gamma(link = "inverse"), data=data.mullid.length))
#sjp.glm(model.length.mullid.gamma)
newdata <- data.frame(expand.grid(depth=unique(data.mullid.length$depth),feature=unique(data.mullid.length$feature),temperature=seq(from=min(data.mullid.length$temperature,na.rm = T),to=max(data.mullid.length$temperature,na.rm=T)),dissolved_oxygen=seq(from=min(data.mullid.length$dissolved_oxygen,na.rm = T),to=max(data.mullid.length$dissolved_oxygen,na.rm=T))))
newdata$p <- predict(model.length.mullid.gamma, newdata)
newdata$SE <- predict(model.length.mullid.gamma, newdata, se.fit=T)$se.fit
newdata$standard_length <- inv.logit(newdata$p)

myshape <- gamma.shape(model.length.mullid.gamma)
gampred <- predict(model.length.mullid.gamma , type = "response", se = T, dispersion = 1/myshape$alpha) 
summary(model.length.mullid.gamma, dispersion = 1/myshape$alpha)
```

## Length post-hoc analysis
```{r}
Anova(model.length.mullid.gamma, type="II", test="Wald")

model.length.mullid.posthoc.depth <- lsmeans::lsmeans(model.length.mullid.gamma, pairwise ~ depth, adjust="Tukey", type="response")
model.length.mullid.posthoc.depth
cld(model.length.mullid.posthoc.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")
lsmip(model.length.mullid.gamma, ~ depth, type="response")
```

Post-hoc analysis for feature
```{r}
model.length.mullid.posthoc.feature <- lsmeans(model.length.mullid.gamma, pairwise ~ feature, adjust="Tukey", type="response")
model.length.mullid.posthoc.feature
cld(model.length.mullid.posthoc.feature, alpha=0.05, Letters=letters, type="response",adjust="Tukey")
lsmip(model.length.mullid.gamma, ~ feature, type="response")
```


# Pomacentridae

```{r}
data.pomacentrid.ontogeny <- filter(data.ontogeny, family=="pomacentridae")
data.pomacentrid.length <- filter(data.length, family=="pomacentridae")
```

## Ontogeny

Seperation in the pomacentrid data, meant we combine the post-flexion and flexion stages


```{r}

data.pomacentrid.ontogeny$stage.posfle <- data.pomacentrid.ontogeny$stage %>% fct_collapse(POSFLE = c("FLE","POS"))
data.pomacentrid.ontogeny$stage.posfle <- factor(data.pomacentrid.ontogeny$stage.posfle, levels = c("PRE", "POSFLE"))

summary(model.ontogeny.pomacentrid.nb <- glm.nb(count ~ offset(log(volume)) + feature * depth * stage.posfle + scale(temperature) + scale(chlorophyll_fluorescence), data=data.pomacentrid.ontogeny))

model.ontogeny.pomacentrid.resids <- simulateResiduals(model.ontogeny.pomacentrid.nb)
testOverdispersion(model.ontogeny.pomacentrid.resids)
testZeroInflation(model.ontogeny.pomacentrid.resids)

#pander(model.ontogeny.pomacentrid.nb)

data.ontogeny.pom.lsmfeature <- lsmeans::lsmeans(model.ontogeny.pomacentrid.nb, ~feature | depth, transform="response")
summary(data.ontogeny.pom.lsmfeature)


```

```{r}
Anova(model.ontogeny.pomacentrid.nb, type="III", test="Wald")

data.ontogeny.pomacentrid.posthoc.depth <- lsmeans::lsmeans(model.ontogeny.pomacentrid.nb, pairwise ~ depth, adjust="Tukey", type="response")
data.ontogeny.pomacentrid.posthoc.depth
cld(data.ontogeny.pomacentrid.posthoc.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

data.ontogeny.pomacentrid.posthoc.ovm.depth <- lsmeans::lsmeans(model.ontogeny.pomacentrid.nb, pairwise ~ depth | stage.posfle, adjust="Tukey", type="response")
data.ontogeny.pomacentrid.posthoc.ovm.depth
cld(data.ontogeny.pomacentrid.posthoc.ovm.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.pomacentrid.nb, depth ~ stage.posfle | feature, type="response")

data.ontogeny.pomacentrid.posthoc.feature.depth <- lsmeans::lsmeans(model.ontogeny.pomacentrid.nb, pairwise ~ depth|feature, adjust="Tukey", type="response")
data.ontogeny.pomacentrid.posthoc.feature.depth
cld(data.ontogeny.pomacentrid.posthoc.feature.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.pomacentrid.nb, depth ~ feature, type="response")

```

## Length
```{r}
#summary(model.length.pom <- glm(total_length ~ feature + depth + dissolved_oxygen, family = gaussian(link="log"), data=data.pomacentrid.length))
summary(model.length.pomacentrid.gamma <- glm(standard_length ~ feature + depth + temperature + salinity + dissolved_oxygen, family = Gamma, data=data.pomacentrid.length))
```

## Length post-hoc analysis
```{r}
Anova(model.length.pomacentrid.gamma, type="II", test="Wald")

model.length.pomacentrid.posthoc <- lsmeans::lsmeans(model.length.pomacentrid.gamma, pairwise ~ depth, type="response")

model.length.pomacentrid.posthoc

cld(model.length.pomacentrid.posthoc, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.length.pomacentrid.gamma, ~ depth, type="response")
```

# Scaridae

```{r}
data.scarid.ontogeny <- filter(data.ontogeny, family=="scaridae")
data.scarid.length <- filter(data.length, family=="scaridae")
```

## Ontogeny
```{r}
data.scarid.ontogeny$stage.prefle <- data.scarid.ontogeny$stage %>% fct_collapse(POSFLE = c("PRE","FLE"))
#data.scarid.ontogeny$stage.prefle <- factor(data.pomacentrid.ontogeny$stage.posfle, levels = c("PREFLE", "POS"))

summary(model.ontogeny.scarid.nb <- glm.nb(count ~ offset(log(volume)) + feature + depth+ stage + scale(temperature) + scale(dissolved_oxygen) +scale(salinity), data=data.scarid.ontogeny))

model.ontogeny.scarid.resids <- simulateResiduals(model.ontogeny.scarid.nb)
testOverdispersion(model.ontogeny.scarid.resids)
testZeroInflation(model.ontogeny.scarid.resids)
```

```{r}
Anova(model.ontogeny.scarid.nb, type="III", test="Wald")

data.ontogeny.scarid.posthoc.stage <- lsmeans::lsmeans(model.ontogeny.scarid.nb, pairwise ~ stage, adjust="Tukey", type="response")
data.ontogeny.scarid.posthoc.stage

data.ontogeny.scarid.posthoc.ovm.stage <- lsmeans::lsmeans(model.ontogeny.scarid.nb, pairwise ~ depth | stage, adjust="Tukey", type="response")
data.ontogeny.scarid.posthoc.ovm.stage
cld(data.ontogeny.scarid.posthoc.ovm.stage, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

data.ontogeny.scarid.posthoc.ovm.depth <- lsmeans::lsmeans(model.ontogeny.scarid.nb, pairwise ~ stage | depth, adjust="Tukey", type="response")
data.ontogeny.scarid.posthoc.ovm.depth
cld(data.ontogeny.scarid.posthoc.ovm.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.scarid.nb, ~ depth, type="response")
```


## Length
```{r}
hist(data.scarid.length$standard_length)
summary(model.length.scarid.gamma <- glm(standard_length ~ depth + temperature + salinity, family=Gamma, data=data.scarid.length))
plot(model.length.scarid.gamma)

```

## Length post-hoc analysis
```{r}
Anova(model.length.scarid.gamma, type="II", test="Wald")

model.length.scarid.posthoc <- lsmeans::lsmeans(model.length.scarid.gamma, pairwise ~ depth, adjust="Tukey", type="response")

model.length.scarid.posthoc

cld(model.length.scarid.posthoc, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.length.scarid.gamma, ~ depth, type="response")
```

```{r}
model.length.scarid.posthoc.feature <- lsmeans(model.length.scarid.gamma, pairwise ~ feature, adjust="Tukey", type="response")
model.length.scarid.posthoc.feature
cld(model.length.scarid.posthoc.feature, alpha=0.05, Letters=letters, type="response",adjust="Tukey")
lsmip(model.length.scarid.gamma, ~ feature, type="response")
```


# Scorpaenidae

```{r}
data.scorpaenid.ontogeny <- filter(data.ontogeny, family=="scorpaenidae")
data.scorpaenid.length <- filter(data.length, family=="scorpaenidae")
```

## Ontogeny
```{r}

#data.scorpaenid.ontogeny$stage.prefle <- data.scorpaenid.ontogeny$stage %>% fct_collapse(POSFLE = c("PRE","FLE"))

summary(model.ontogeny.scorpaenid.nb <- glm.nb(count ~ offset(log(volume)) + feature + feature:stage + depth*stage + scale(temperature), data=data.scorpaenid.ontogeny))

model.ontogeny.scorpaenid.resids <- simulateResiduals(model.ontogeny.scorpaenid.nb)
testOverdispersion(model.ontogeny.scorpaenid.resids)
testZeroInflation(model.ontogeny.scorpaenid.resids)
```

### Post-hoc
```{r}
Anova(model.ontogeny.scorpaenid.nb, type="III", test="Wald")

data.ontogeny.scorpaenid.posthoc.ovm <- lsmeans::lsmeans(model.ontogeny.scorpaenid.nb, pairwise ~ depth|stage, adjust="Tukey", type="response")
data.ontogeny.scorpaenid.posthoc.ovm
cld(data.ontogeny.scorpaenid.posthoc.ovm, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

data.ontogeny.scorpaenid.posthoc.ovm.depth <- lsmeans::lsmeans(model.ontogeny.scorpaenid.nb, pairwise ~ stage|depth, adjust="Tukey", type="response")
data.ontogeny.scorpaenid.posthoc.ovm.depth
cld(data.ontogeny.scorpaenid.posthoc.ovm.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.scorpaenid.nb, stage ~ depth, type="response")

data.ontogeny.scorpaenid.posthoc.feature.stage <- lsmeans::lsmeans(model.ontogeny.scorpaenid.nb, pairwise ~ feature | stage, adjust="Tukey", type="response")
data.ontogeny.scorpaenid.posthoc.feature.stage
cld(data.ontogeny.scorpaenid.posthoc.feature.stage, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

data.ontogeny.scorpaenid.posthoc.feature.stage <- lsmeans::lsmeans(model.ontogeny.scorpaenid.nb, pairwise ~ stage | feature, adjust="Tukey", type="response")
data.ontogeny.scorpaenid.posthoc.feature.stage
cld(data.ontogeny.scorpaenid.posthoc.feature.stage, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.scorpaenid.nb, stage ~ feature, type="response")
```


## Length

```{r}
hist(data.scorpaenid.length$total_length)
summary(model.length.scorpaenid.gauss <- glm(standard_length ~ feature*depth + temperature + salinity + dissolved_oxygen, family = gaussian(link="log"), data=data.scorpaenid.length))
summary(model.length.scorpaenid.gamma <- glm(standard_length ~ feature + depth + salinity, family = Gamma, data=data.scorpaenid.length))
plot(model.length.scorpaenid.gamma)
```

## Length post-hoc analysis
```{r}
Anova(model.length.scorpaenid.gamma, type="III", test="Wald")

model.length.scorpaenid.posthoc <- lsmeans(model.length.scorpaenid.gamma, pairwise ~ depth, adjust="Tukey", type="response")

model.length.scorpaenid.posthoc

cld(model.length.scorpaenid.posthoc, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.length.scorpaenid.gamma, ~ depth, type="response")
```

# Serranidae


```{r}
data.serranid.ontogeny <- filter(data.ontogeny, family=="serranidae")
data.serranid.length <- filter(data.length, family=="serranidae")
```

## Ontogeny
```{r}

#data.serranid.ontogeny$stage.prefle <- data.serranid.ontogeny$stage %>% fct_collapse(POSFLE = c("PRE","FLE"))

summary(model.ontogeny.serranid.nb <- glm.nb(count ~ offset(log(volume)) + depth*stage+ scale(dissolved_oxygen), data=data.serranid.ontogeny))

model.ontogeny.serranid.resids <- simulateResiduals(model.ontogeny.serranid.nb)
testOverdispersion(model.ontogeny.serranid.resids)
testZeroInflation(model.ontogeny.serranid.resids)
```

```{r}
Anova(model.ontogeny.serranid.nb, type="III", test="Wald")

data.ontogeny.serranid.posthoc.ovm <- lsmeans::lsmeans(model.ontogeny.serranid.nb, pairwise ~ depth|stage, adjust="Tukey", type="response")

data.ontogeny.serranid.posthoc.ovm
cld(data.ontogeny.serranid.posthoc.ovm, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

data.ontogeny.serranid.posthoc.ovm.depth <- lsmeans::lsmeans(model.ontogeny.serranid.nb, pairwise ~ stage|depth, adjust="Tukey", type="response")
data.ontogeny.serranid.posthoc.ovm.depth
cld(data.ontogeny.serranid.posthoc.ovm.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.serranid.nb, stage ~ depth, type="response")
```


## Length
```{r}
#summary(model.length.serranid.gauss <- glm(total_length ~ feature*depth + temperature + salinity + dissolved_oxygen, family = gaussian(link="log"), data=data.serranid.length))
summary(model.length.serranid.gamma <- glm(standard_length ~ feature + depth + temperature, family = Gamma(link="log"), data=data.serranid.length))
```

## Length post-hoc analysis
```{r}
Anova(model.length.serranid.gamma, type="II", test="Wald")

model.length.serranid.posthoc <- lsmeans::lsmeans(model.length.serranid.gamma, pairwise ~ depth, adjust="Tukey", type="response")

model.length.serranid.posthoc

cld(model.length.serranid.posthoc, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.length.serranid.gamma, ~ depth, type="response")
```

# Synodontid

```{r}
data.synodontid.ontogeny <- filter(data.ontogeny, family=="synodontidae")
data.synodontid.length <- filter(data.length, family=="synodontidae")
```

## Ontogeny
```{r}

#data.synodontid.ontogeny$stage.prefle <- data.synodontid.ontogeny$stage %>% fct_collapse(POSFLE = c("PRE","FLE"))

summary(model.ontogeny.synodontid.nb <- glm.nb(count ~ offset(log(volume)) + feature + feature:depth + feature:stage + depth*stage +scale(temperature) + scale(dissolved_oxygen), data=data.synodontid.ontogeny))

model.ontogeny.synodontid.resids <- simulateResiduals(model.ontogeny.synodontid.nb)
testOverdispersion(model.ontogeny.synodontid.resids)
testZeroInflation(model.ontogeny.synodontid.resids)
```

```{r}
Anova(model.ontogeny.synodontid.nb, type="III")

data.ontogeny.synodontid.posthoc.ovm <- lsmeans::lsmeans(model.ontogeny.synodontid.nb, pairwise ~ depth|stage, adjust="Tukey", type="response")
data.ontogeny.synodontid.posthoc.ovm
cld(data.ontogeny.synodontid.posthoc.ovm, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

data.ontogeny.synodontid.posthoc.ovm.depth <- lsmeans::lsmeans(model.ontogeny.synodontid.nb, pairwise ~ stage|depth, adjust="Tukey", type="response")
data.ontogeny.synodontid.posthoc.ovm.depth
cld(data.ontogeny.synodontid.posthoc.ovm.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.synodontid.nb, stage ~ depth, type="response")
```

Feature post-hoc
```{r}
Anova(model.ontogeny.synodontid.nb, type="II", test="Wald")

data.ontogeny.synodontid.posthoc.feature <- lsmeans(model.ontogeny.synodontid.nb, pairwise ~ stage | feature, adjust="Tukey", type="response")
data.ontogeny.synodontid.posthoc.feature
cld(data.ontogeny.synodontid.posthoc.feature, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.synodontid.nb, stage ~ feature, type="response")

data.ontogeny.synodontid.posthoc.feature.depth <- lsmeans(model.ontogeny.synodontid.nb, pairwise ~ feature|depth, adjust="Tukey", type="response")
data.ontogeny.synodontid.posthoc.feature.depth
cld(data.ontogeny.synodontid.posthoc.feature.depth, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.ontogeny.synodontid.nb, depth ~ feature, type="response")
```

## Length
```{r}
#summary(model.length.synodontid.gauss <- glm(total_length ~ feature*depth + temperature + salinity + dissolved_oxygen, family = gaussian(link="log"), data=data.synodontid.length))
summary(model.length.synodontid.gamma <- glm(standard_length ~ feature + depth + dissolved_oxygen, family = Gamma, data=data.synodontid.length), type="response")
```
## Length post-hoc analysis
```{r}
Anova(model.length.synodontid.gamma, type="II", test="Wald")

model.length.synodontid.posthoc <- lsmeans(model.length.synodontid.gamma, pairwise ~ depth, adjust="Tukey", type="response")

model.length.synodontid.posthoc

cld(model.length.synodontid.posthoc, alpha=0.05, Letters=letters, type="response",adjust="Tukey")

lsmip(model.length.synodontid.gamma, ~ depth, type="response")
```

```{r}
panderOptions('table.alignment.default', function(model.ontogeny.labrid.nb)
    ifelse(sapply(model.ontogeny.labrid.nb, is.numeric), 'right', 'left'))
panderOptions('table.split.table', Inf)
panderOptions('big.mark', ",")
panderOptions('keep.trailing.zeros', TRUE)
panderOptions('table.style','rmarkdown')
panderOptions('table.emphasize.rownames',FALSE)
panderOptions('table.alignment.rownames','left')
panderOptions('round',3)
pander(model.ontogeny.labrid.nb)
```

```{r}
sjt.glm(model.ontogeny.synodontid.nb,file="table.html")
```

Stargazer output
```{r}
stargazer(model.length.labrid.gamma,model.length.mullid.gamma, model.length.pomacentrid.gamma,model.length.scarid.gamma, model.length.scorpaenid.gamma, model.length.serranid.gamma, model.length.synodontid.gamma, 
          star.cutoffs = c(0.05,0.01,0.001),
          dep.var.labels = "Length (mm)",
          covariate.labels = c("Feature (Eddy)", "Depth (25 m)", "Depth (75 m)", "Temperature", "Chlorophyll", "Salinity", "Dissolved Oxygen"),
          model.numbers = FALSE,
          column.labels = c("Labridae", "Mullidae", "Pomacentridae", "Scaridae", "Scorpaenidae", "Serranidae","Synodontidae"),
          omit.stat = c("aic","ll"),
          type='text')

stargazer(model.ontogeny.labrid.nb,model.ontogeny.mullid.nb, model.ontogeny.scorpaenid.nb, model.ontogeny.serranid.nb, model.ontogeny.synodontid.nb,
          star.cutoffs = c(0.05,0.01,0.001),
          dep.var.labels = "Length (mm)",
          covariate.labels = c("Feature(Eddy)", "Depth(25)", "Depth(75)","Stage(FLE)", "Stage(POS)", "Temperature","Feature(Eddy):Depth(25)","Feature(Eddy):Depth(75)", "Chlorophyll","Feature(Eddy):Stage(FLE)","Feature(Eddy):Stage(POS)", "Dissolved Oxygen","Depth(25):Stage(FLE)","Depth(25):Stage(POS)","Depth(75):Stage(FLE)","Depth(75):Stage(POS)","Depth(25):Stage(FLE)","Depth(25):Stage(POS)","Depth(75):Stage(FLE)","Depth(75):Stage(POS)"),
          model.numbers = FALSE,
          column.labels = c("Labridae", "Mullidae", "Scorpaenidae", "Serranidae","Synodontidae"),
          omit.stat = c("aic","ll"),
          type='text')

stargazer(model.ontogeny.pomacentrid.nb, 
          star.cutoffs = c(0.05,0.01,0.001),
          dep.var.labels = "Concentration (m3)",
          covariate.labels = c("Feature(Eddy)", "Depth(25)", "Depth(75)","Stage(FLEPOS)", "Temperature","Chlorophyll","Feature(Eddy):Depth(25)","Feature(Eddy):Depth(75)", "Feature(Eddy):Stage(FLEPOS)", "Depth(25):Stage(FLEPOS)","Depth(75):Stage(FLEPOS)","Feature(Eddy):Depth(25):Stage(FLEPOS)","Feature(Eddy):Depth(75):Stage(FLEPOS)"),
          omit.stat = c("aic","ll"),
          type='html')
```


