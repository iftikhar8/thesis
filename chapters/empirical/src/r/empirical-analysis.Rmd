---
title: "Empirical analysis"
output:
  word_document: default
  pdf_document: default
  html_notebook: default
---

# The analysis of my empirical chapter - ORLE methods 

```{r Packages, include=FALSE}
library(tidyverse)
library(corrr)
library(MASS)
library(lsmeans)
library(lme4)
library(pscl)
library(boot)
library(DHARMa)
library(AER)
```

```{r Load data, include=FALSE}
load(file="length.RData")
load(file="ontogeny.RData")
source("empirical-functions.R")

data.ontogeny$stage <- factor(data.ontogeny$stage, levels=c("PRE","FLE","POS"))
```




# Exploratory analysis

## Check for correlations. DO and Chloro look highly correlated - so only include one in any model
```{r}
data.environment <- data.ontogeny %>% ungroup() %>% dplyr::select(temperature, salinity, chlorophyll_fluorescence, dissolved_oxygen) 
correlate(data.environment)
```

## What does the data look like?

Looks like poisson or negative binomial distributions - with perhaps a tendency to be zero-inflated? Some have a lot of zeros in the output.

```{r}
ggplot(data=data.ontogeny, aes(conc)) + geom_histogram() + facet_wrap(~ family, scales="free") + labs(x="count")
```


```{r Explore ontogeny data}
#data.ontogeny.summary <- na.omit(data.ontogeny)
data.ontogeny.interaction_ds <-  summarize(group_by(na.omit(data.ontogeny), family, depth,stage), conc.mean = mean(conc), conc.se = sd(conc)/n())
data.ontogeny.interaction_fds <-  summarize(group_by(na.omit(data.ontogeny), feature, family, depth,stage), conc.mean = mean(conc), conc.se = sd(conc)/n())
data.ontogeny.depth <-  summarize(group_by(na.omit(data.ontogeny), family, depth), conc.mean = mean(conc), conc.se = sd(conc)/n())
data.ontogeny.stage <-  summarize(group_by(na.omit(data.ontogeny), family, stage), conc.mean = mean(conc), conc.se = sd(conc)/n())
data.ontogeny.feature <-  summarize(group_by(na.omit(data.ontogeny), family, feature), conc.mean = mean(conc), conc.se = sd(conc)/n())

ggplot(aes(y=conc.mean, x=depth, group=stage, colour=stage), data=data.ontogeny.interaction_ds) + geom_point() + geom_line() + geom_errorbar(aes(ymin=conc.mean-conc.se,ymax=conc.mean+conc.se),width=.1) + facet_wrap(~family, scales = "free")

ggplot(aes(y=conc.mean, x=depth, group=family), data=data.ontogeny.depth) + geom_point(aes(colour=family)) + geom_line(aes(colour=family))
ggplot(aes(y=conc.mean, x=stage, group=family), data=data.ontogeny.stage) + geom_point(aes(group=family, colour=family)) + geom_line(aes(colour=family))
ggplot(aes(y=conc.mean, x=feature, group=family), data=data.ontogeny.feature) + geom_point(aes(group=family, colour=family)) + geom_line(aes(colour=family))

ggplot(aes(y=conc.mean, x=depth, group=stage, colour=stage), data=data.ontogeny.interaction_fds) + geom_point() + geom_line() + facet_grid(feature ~ family, scales = "free")

ggplot(data=na.omit(data.ontogeny), aes(y=conc, x=temperature)) + geom_jitter(aes(colour = family)) + stat_smooth(aes(colour=family), method="lm", se=FALSE)
ggplot(data=na.omit(data.ontogeny), aes(y=conc, x=salinity)) + geom_jitter(aes(colour = family)) + stat_smooth(aes(group=family, colour=family),method="lm",se=FALSE)
ggplot(data=na.omit(data.ontogeny), aes(y=conc, x=chlorophyll_fluorescence)) + geom_jitter(aes(colour = family)) + stat_smooth(aes(colour=family), method="lm",se=FALSE)
ggplot(data=na.omit(data.ontogeny), aes(y=conc, x=dissolved_oxygen)) + geom_jitter(aes(colour = family)) + stat_smooth(aes(group=family,colour=family), method="glm",se=FALSE)

```

```{r Zero inflated data %}
data.ontogeny$stage <- factor(data.ontogeny$stage, levels=c("PRE","FLE","POS"))
ggplot(data=data.ontogeny, aes(y=conc, x=depth, group=stage, fill=stage)) + facet_wrap(~family, scales="free") + stat_summary_bin(fun.y="mean", geom="bar", position=position_dodge(width=0.90)) + stat_summary(fun.data = "mean_cl_boot", geom = "linerange", aes(width=0.15),position=position_dodge(width=0.90)) + labs(x="Depth", y="Concentration") + theme_classic() 
ggsave("../../figs/depth-stage-all.png")
```

# Labrid

```{r}
data.labrid.ontogeny <- filter(data.ontogeny, family=="labridae")
data.labrid.length <- filter(data.length, family=="labridae")
```


## Ontogeny
```{r}
summary(model.ontogeny.labrid.nb <- glm.nb(count ~ feature + depth + stage + feature:depth + 
    feature:stage + depth:stage+ scale(temperature) + offset(log(volume)),data=data.labrid.ontogeny))


#p.resids <- simulateResiduals(model.ontogeny.labrid.p)
#dispersiontest(model.ontogeny.labrid.p)
#testZeroInflation(p.resids)
model.ontogeny.labrid.resids <- simulateResiduals(model.ontogeny.labrid.nb)
testOverdispersion(model.ontogeny.labrid.resids)
testZeroInflation(model.ontogeny.labrid.resids)
```

## Length
```{r}
summary(model.length.labrid <- glm(total_length ~ feature + depth + scale(temperature) + scale(chlorophyll_fluorescence), family = Gamma, data=filter(data.length, family=="labridae")))
```

# Mullid final models

```{r}
data.mullid.ontogeny <- filter(data.ontogeny, family=="mullidae")
data.mullid.length <- filter(data.length, family=="mullidae")
```


# Ontogeny
```{r}
summary(model.ontogeny.mullid.nb <- glm.nb(count ~ offset(log(volume)) + feature +  feature:depth + feature:stage + depth*stage + scale(chlorophyll_fluorescence), data=data.mullid.ontogeny))
drop1(model.ontogeny.mullid.nb)
gof <- 1 - pchisq(summary(model.ontogeny.mullid.nb)$deviance, summary(model.ontogeny.mullid.nb)$df.residual)
pander(model.ontogeny.mullid.nb)

```


## Length
```{r}
#summary(model.length.mullid.norm <- glm(total_length ~ feature + depth + scale(temperature), family = gaussian(link="log"), data=data.mullid.length))
summary(model.length.mullid.gamma <- glm(total_length ~ feature + depth + temperature, family = Gamma, data=data.mullid.length))
sjp.glm(model.length.mullid.gamma)
```



# Pomacentridae

```{r}
data.pomacentrid.ontogeny <- filter(data.ontogeny, family=="pomacentridae")
data.pomacentrid.length <- filter(data.length, family=="pomacentridae")
```

## Ontogeny

Seperation in the pomacentrid data, meant we combine the post-flexion and flexion stages


```{r}

data.pomacentrid.ontogeny$stage.posfle <- data.pomacentrid.ontogeny$stage %>% fct_collapse(POSFLE = c("FLE","POS"))
data.pomacentrid.ontogeny$stage.posfle <- factor(data.pomacentrid.ontogeny$stage.posfle, levels = c("PRE", "POSFLE"))

summary(model.ontogeny.pomacentrid.nb <- glm.nb(count ~ offset(log(volume)) + feature*depth*stage.posfle + scale(temperature) + scale(chlorophyll_fluorescence), data=data.pomacentrid.ontogeny))

model.ontogeny.pomacentrid.resids <- simulateResiduals(model.ontogeny.pomacentrid.nb)
testOverdispersion(model.ontogeny.pomacentrid.resids)
testZeroInflation(model.ontogeny.pomacentrid.resids)

pander(model.ontogeny.pomacentrid.nb)

data.ontogeny.pom.lsmfeature <- lsmeans(model.ontogeny.pomacentrid.nb, ~feature | depth, transform="response")
summary(data.ontogeny.pom.lsmfeature)


```

## Length
```{r}
#summary(model.length.pom <- glm(total_length ~ feature + depth + dissolved_oxygen, family = gaussian(link="log"), data=data.pomacentrid.length))
summary(model.length.pomacentrid.gamma <- glm(total_length ~ feature + depth + temperature + salinity + dissolved_oxygen, family = Gamma, data=data.pomacentrid.length))
model.length.pom.lsdepth <- lsmeans(model.length.pom, ~depth, transform="response")
summary(model.length.pom.lsdepth)
pairs(model.length.pom.lsdepth)
plot(model.length.pom) 
```

# Scaridae

```{r}
data.scarid.ontogeny <- filter(data.ontogeny, family=="scaridae")
data.scarid.length <- filter(data.length, family=="scaridae")
```

## Ontogeny
```{r}
summary(model.ontogeny.scarid.nb <- glm.nb(count ~ offset(log(volume)) + feature + depth + stage + scale(temperature) + scale(dissolved_oxygen) +scale(salinity), data=data.scarid.ontogeny))

model.ontogeny.scarid.resids <- simulateResiduals(model.ontogeny.scarid.nb)
testOverdispersion(model.ontogeny.scarid.resids)
testZeroInflation(model.ontogeny.scarid.resids)
```

## Length
```{r}
hist(data.scarid.length$total_length)
summary(model.length.scarid.gamma <- glm(total_length ~ depth + temperature + salinity, family = Gamma, data=data.scarid.length))
plot(model.length.scarid.gamma)
```

# Scorpaenidae

```{r}
data.scorpaenid.ontogeny <- filter(data.ontogeny, family=="scorpaenidae")
data.scorpaenid.length <- filter(data.length, family=="scorpaenidae")
```

## Ontogeny
```{r}

#data.scorpaenid.ontogeny$stage.prefle <- data.scorpaenid.ontogeny$stage %>% fct_collapse(POSFLE = c("PRE","FLE"))

summary(model.ontogeny.scorpaenid.nb <- glm.nb(count ~ offset(log(volume)) + feature + feature:stage + depth*stage + scale(temperature), data=data.scorpaenid.ontogeny))

model.ontogeny.scorpaenid.resids <- simulateResiduals(model.ontogeny.scorpaenid.nb)
testOverdispersion(model.ontogeny.scorpaenid.resids)
testZeroInflation(model.ontogeny.scorpaenid.resids)
```

## Length

```{r}
hist(data.scorpaenid.length$total_length)
summary(model.length.scorpaenid.gauss <- glm(total_length ~ feature*depth + temperature + salinity + dissolved_oxygen, family = gaussian(link="log"), data=data.scorpaenid.length))
summary(model.length.scorpaenid.gamma <- glm(total_length ~ feature + depth + salinity, family = Gamma, data=data.scorpaenid.length))
plot(model.length.scorpaenid.gamma)
```

# Serranidae


```{r}
data.serranid.ontogeny <- filter(data.ontogeny, family=="serranidae")
data.serranid.length <- filter(data.length, family=="serranidae")
```

## Ontogeny
```{r}

#data.serranid.ontogeny$stage.prefle <- data.serranid.ontogeny$stage %>% fct_collapse(POSFLE = c("PRE","FLE"))

summary(model.ontogeny.serranid.nb <- glm.nb(count ~ offset(log(volume)) + depth*stage+ scale(dissolved_oxygen), data=data.serranid.ontogeny))

model.ontogeny.serranid.resids <- simulateResiduals(model.ontogeny.serranid.nb)
testOverdispersion(model.ontogeny.serranid.resids)
testZeroInflation(model.ontogeny.serranid.resids)
```


## Length
```{r}
#summary(model.length.serranid.gauss <- glm(total_length ~ feature*depth + temperature + salinity + dissolved_oxygen, family = gaussian(link="log"), data=data.serranid.length))
summary(model.length.serranid.gamma <- glm(total_length ~ feature + depth + temperature + salinity, family = Gamma, data=data.serranid.length))
```

# Synodontid

```{r}
data.synodontid.ontogeny <- filter(data.ontogeny, family=="synodontidae")
data.synodontid.length <- filter(data.length, family=="synodontidae")
```

## Ontogeny
```{r}

#data.synodontid.ontogeny$stage.prefle <- data.synodontid.ontogeny$stage %>% fct_collapse(POSFLE = c("PRE","FLE"))

summary(model.ontogeny.synodontid.nb <- glm.nb(count ~ offset(log(volume)) + feature + feature:depth + feature:stage + depth*stage+ +scale(temperature) + scale(dissolved_oxygen), data=data.synodontid.ontogeny))

model.ontogeny.synodontid.resids <- simulateResiduals(model.ontogeny.synodontid.nb)
testOverdispersion(model.ontogeny.synodontid.resids)
testZeroInflation(model.ontogeny.synodontid.resids)
```

## Length
```{r}
#summary(model.length.synodontid.gauss <- glm(total_length ~ feature*depth + temperature + salinity + dissolved_oxygen, family = gaussian(link="log"), data=data.synodontid.length))
summary(model.length.synodontid.gamma <- glm(total_length ~ feature + depth + dissolved_oxygen, family = Gamma, data=data.synodontid.length))
```

```{r}
panderOptions('table.alignment.default', function(model.ontogeny.labrid.nb)
    ifelse(sapply(model.ontogeny.labrid.nb, is.numeric), 'right', 'left'))
panderOptions('table.split.table', Inf)
panderOptions('big.mark', ",")
panderOptions('keep.trailing.zeros', TRUE)
panderOptions('table.style','rmarkdown')
panderOptions('table.emphasize.rownames',FALSE)
panderOptions('table.alignment.rownames','left')
panderOptions('round',3)
pander(model.ontogeny.labrid.nb)
```

```{r}
sjt.glm(model.ontogeny.synodontid.nb,file="table.html")
```


