---
title: "Empirical analysis"
output:
  word_document: default
  pdf_document: default
  html_notebook: default
---

# The analysis of my empirical chapter - ORLE methods 

```{r Packages, include=FALSE}
library(tidyverse)
library(corrr)
library(MASS)
library(lsmeans)
library(lme4)
require(pscl)
require(boot)
```

```{r Load data, include=FALSE}
load(file="length.RData")
load(file="ontogeny.RData")
source("empirical-functions.R")
```




# Exploratory analysis

## Check for correlations - any correlated enough to remove??? To me DO and Chloro look highly correlated
```{r}
data.environment <- data.ontogeny %>% ungroup() %>% dplyr::select(temperature, salinity, chlorophyll_fluorescence, dissolved_oxygen) 
correlate(data.environment)
```

## What does the data look like?
```{r}
ggplot(data=data.ontogeny, aes(conc)) + 
  geom_histogram(breaks=seq(0, 0.15, by=0.001)) + facet_wrap(~ family) + labs(x="concentration")
```


```{r Explore ontogeny data}
#data.ontogeny.summary <- na.omit(data.ontogeny)
data.ontogeny.interaction_ds <-  summarize(group_by(na.omit(data.ontogeny), family, depth,stage), conc.mean = mean(conc), conc.se = sd(conc)/n())
data.ontogeny.interaction_fds <-  summarize(group_by(na.omit(data.ontogeny), feature, family, depth,stage), conc.mean = mean(conc), conc.se = sd(conc)/n())
data.ontogeny.depth <-  summarize(group_by(na.omit(data.ontogeny), family, depth), conc.mean = mean(conc), conc.se = sd(conc)/n())
data.ontogeny.stage <-  summarize(group_by(na.omit(data.ontogeny), family, stage), conc.mean = mean(conc), conc.se = sd(conc)/n())
data.ontogeny.feature <-  summarize(group_by(na.omit(data.ontogeny), family, feature), conc.mean = mean(conc), conc.se = sd(conc)/n())

ggplot(aes(y=conc.mean, x=depth, group=stage, colour=stage), data=data.ontogeny.interaction_ds) + geom_point() + geom_line() + geom_errorbar(aes(ymin=conc.mean-conc.se,ymax=conc.mean+conc.se),width=.1) + facet_wrap(~family, scales = "free")

ggplot(aes(y=conc.mean, x=depth, group=family), data=data.ontogeny.depth) + geom_point(aes(colour=family)) + geom_line(aes(colour=family))
ggplot(aes(y=conc.mean, x=stage, group=family), data=data.ontogeny.stage) + geom_point(aes(group=family, colour=family)) + geom_line(aes(colour=family))
ggplot(aes(y=conc.mean, x=feature, group=family), data=data.ontogeny.feature) + geom_point(aes(group=family, colour=family)) + geom_line(aes(colour=family))

ggplot(aes(y=conc.mean, x=depth, group=stage, colour=stage), data=data.ontogeny.interaction_fds) + geom_point() + geom_line() + facet_grid(feature ~ family, scales = "free")

ggplot(data=na.omit(data.ontogeny), aes(y=conc, x=temperature)) + geom_jitter(aes(colour = family)) + stat_smooth(aes(colour=family), method="lm", se=FALSE)
ggplot(data=na.omit(data.ontogeny), aes(y=conc, x=salinity)) + geom_jitter(aes(colour = family)) + stat_smooth(aes(group=family, colour=family),method="lm",se=FALSE)
ggplot(data=na.omit(data.ontogeny), aes(y=conc, x=chlorophyll_fluorescence)) + geom_jitter(aes(colour = family)) + stat_smooth(aes(colour=family), method="lm",se=FALSE)
ggplot(data=na.omit(data.ontogeny), aes(y=conc, x=dissolved_oxygen)) + geom_jitter(aes(colour = family)) + stat_smooth(aes(group=family,colour=family), method="lm",se=FALSE)

```

```{r Zero inflated data %}
data.ontogeny$stage <- factor(data.ontogeny$stage, levels=c("PRE","FLE","POS"))
ggplot(data=data.ontogeny, aes(y=conc, x=depth, group=stage, fill=stage)) + facet_wrap(~family, scales="free") + stat_summary_bin(fun.y="mean", geom="bar", position=position_dodge(width=0.90)) + stat_summary(fun.data = "mean_cl_boot", geom = "linerange", aes(width=0.15),position=position_dodge(width=0.90)) + labs(x="Depth", y="Concentration") + theme_classic() 
ggsave("../../figs/depth-stage-all.png")
```

Function to test for overdispersion in the model
```{r}
overdispersion_check <- function(model) {
  # ## number of variance parameters in 
  # ## an n-by-n variance-covariance matrix
  # vpars <- function(m) {
  #   nrow(m)*(nrow(m)+1)/2
  # }
  # model.df <- sum(sapply(VarCorr(model),vpars))+length(fixef(model))
  # rdf <- nrow(model.frame(model))-model.df
  
  ## Alternative (newer) number of variance parameters https://github.com/lme4/lme4/issues/220
  rdf <- df.residual(model)
  
  ## Test
  rp <- residuals(model, type="pearson")
  Pearson.chisq <- sum(rp^2)
  prat <- Pearson.chisq/rdf # Dispersion. chris added
  pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE)
  c(chisq=Pearson.chisq,ratio=prat,rdf=rdf,p=pval)
}

```

# Mullid final models

# Ontogeny
```{r}
summary(model.ontogeny.depthstage.zinb <- zeroinfl(count ~ offset(log(volume)) + depth*stage + temp.scale + do.scale,  dist="negbin", link="logit", data=data.ontogeny),control = glm.control(maxit=200))
```


## Length
```{r}
summary(model.length.full <- glm(total_length ~ feature + depth + temp.scale, family = gaussian(link="log"), data=data.length))
plot(model.length.full)
```


## Length




# Pomacentrid story 

## Get the labrid data and add the observation variable
```{r Pomacentrid data}
data.ontogeny.pomacentrid <- filter(data.ontogeny, family =="pomacentridae")
data.ontogeny.pomacentrid$obs <- 1:nrow(data.ontogeny.pomacentrid)
str(data.ontogeny.pomacentrid$obs)
```

##
```{r Depth model}
model.ontogeny.pomacentrid.d <- glmer(count ~ offset(log(volume)) + depth + (1|obs), family=poisson(link="log"), data=data.ontogeny.pomacentrid, nAGQ=2)
overdispersion_check(model.ontogeny.pomacentrid.d)
summary(model.ontogeny.pomacentrid.d)
```

```{r Stage model}
model.ontogeny.pomacentrid.s <- glmer(count ~ offset(log(volume)) + stage + (1|obs), family=poisson(link="log"), data=data.ontogeny.pomacentrid, nAGQ=2)
overdispersion_check(model.ontogeny.pomacentrid.s)
summary(model.ontogeny.pomacentrid.s)
```

```{r Feature model}
model.ontogeny.pomacentrid.f <- glmer(count ~ offset(log(volume)) + feature + (1|obs), family=poisson(link="log"), data=data.ontogeny.pomacentrid, nAGQ=2)
overdispersion_check(model.ontogeny.pomacentrid.f)
summary(model.ontogeny.pomacentrid.f)
```

```{r Pomacentrid temperature model}
model.ontogeny.pomacentrid.t <- glmer(count ~ offset(log(volume)) + temperature + (1|obs), family=poisson(link="log"), data=data.ontogeny.pomacentrid, nAGQ=2)
overdispersion_check(model.ontogeny.pomacentrid.t)
summary(model.ontogeny.pomacentrid.t)
```

```{r Pomacentrid salinity model}
model.ontogeny.pomacentrid.salt <- glmer(count ~ offset(log(volume)) + salinity + (1|obs), family=poisson(link="log"), data=data.ontogeny.pomacentrid, nAGQ=2)
overdispersion_check(model.ontogeny.pomacentrid.salt)
summary(model.ontogeny.pomacentrid.salt)
```

```{r Pomacentrid dissolved oxygen model}
model.ontogeny.pomacentrid.o2 <- glmer(count ~ offset(log(volume)) + dissolved_oxygen + (1|obs), family=poisson(link="log"), data=data.ontogeny.pomacentrid, nAGQ=2)
overdispersion_check(model.ontogeny.pomacentrid.o2)
summary(model.ontogeny.pomacentrid.o2)
```

```{r Pomacentrid chlorophyll model}
model.ontogeny.pomacentrid.ch <- glmer(count ~ offset(log(volume)) + chlorophyll_fluorescence + (1|obs), family=poisson(link="log"), data=data.ontogeny.pomacentrid, nAGQ=2)
overdispersion_check(model.ontogeny.pomacentrid.ch)
summary(model.ontogeny.pomacentrid.ch)
```

```{r Pomacentrid depth x stage model}
model.ontogeny.pomacentrid.ds <- glmer(count ~ offset(log(volume)) + depth * stage + (1|obs), family=poisson(link="log"), data=data.ontogeny.pomacentrid, nAGQ=10)
overdispersion_check(model.ontogeny.pomacentrid.ds)
summary(model.ontogeny.pomacentrid.ds)
```

```{r Pomacentrid feature x depth model}
model.ontogeny.pomacentrid.ds <- glmer(count ~ offset(log(volume)) + feature * depth + (1|obs), family=poisson(link="log"), data=data.ontogeny.pomacentrid, nAGQ=10)
overdispersion_check(model.ontogeny.pomacentrid.ds)
summary(model.ontogeny.pomacentrid.ds)
```

```{r Pomacentrid feature x stage model}
model.ontogeny.pomacentrid.ds <- glmer(count ~ offset(log(volume)) + feature * stage + (1|obs), family=poisson(link="log"), data=data.ontogeny.pomacentrid, nAGQ=10)
overdispersion_check(model.ontogeny.pomacentrid.ds)
summary(model.ontogeny.pomacentrid.ds)
```

```{r Pomacentrid feature x depth x stage model}
model.ontogeny.pomacentrid.ds <- glmer(count ~ offset(log(volume)) + feature * depth * stage + (1|obs), family=poisson(link="log"), data=data.ontogeny.pomacentrid, nAGQ=2, control=glmerControl(optimizer="bobyqa"))
overdispersion_check(model.ontogeny.pomacentrid.ds)
summary(model.ontogeny.pomacentrid.ds)
```


```{r}
summary(zeroinfl(dist=c("poisson"), count ~ offset(log(volume)) + depth * stage, data=data.ontogeny.pomacentrid))
```

## 2. Feature x depth x stage
```{r Labrid fds}
data.ontogeny.labrid <- filter(data.ontogeny, family =="labridae")
labrid.nb.fds <- glm.nb(count ~ offset(log(volume)) + feature * depth * stage, data.ontogeny.labrid)
summary(labrid.nb.fds)
plot(labrid.nb.fds)
anova(labrid.nb.fds, test="Chisq")
# Using lsmeans
comp <-  lsmeans(labrid.nb.fds, ~ depth*stage*feature)
summary(comp)
lsmip(labrid.nb.fds, stage ~ depth | feature)
```

## 3. The whole shebang
```{r}
labrid.nb.all <- glm.nb(count ~ offset(log(volume)) + feature * depth * stage + temperature + salinity + chlorophyll_fluorescence + dissolved_oxygen, data.ontogeny.labrid)
summary(labrid.nb.all)
plot(labrid.nb.all)
```

## 4. The whole shebang minus feature
```{r}
labrid.nb.all <- glm.nb(count ~ offset(log(volume)) + depth * stage + temperature + salinity + chlorophyll_fluorescence + dissolved_oxygen, data.ontogeny.labrid)
summary(labrid.nb.all)
plot(labrid.nb.all)
```

## 5. Adding site as a random factor (but didn't converge)
Will need to try the averages solution and see what that does
```{r}
labrid.mnb <- glmer.nb(count ~ offset(log(volume)) + (1|site) + depth * stage, control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=100000)), data.ontogeny.labrid)
summary(labrid.mnb)
anova(labrid.mnb,labrid.nb.ds)
```

```{r}
labrid.mnb.fds <- glmer.nb(count ~ offset(log(volume)) + (1|site) + feature * depth * stage, control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=100000)), data.ontogeny.labrid)
summary(labrid.mnb.fds)
anova(labrid.mnb.fds,labrid.nb.fds)
```

Trying a ZIP model
```{r}
ggplot(data.ontogeny.labrid, aes(conc+1)) + geom_histogram() + scale_x_log10()

summary(m1 <- zeroinfl(count ~ offset(log(volume)) + feature * depth * stage + temperature + salinity + dissolved_oxygen, data = data.ontogeny.labrid))

mnull <- update(m1, . ~ 1)
pchisq(2 * (logLik(m1) - logLik(mnull)), df = 3, lower.tail = FALSE)

summary(p1 <- glm(count ~ offset(log(volume)) + feature * depth * stage + temperature + salinity + dissolved_oxygen, family = poisson, data = data.ontogeny.labrid))
vuong(p1, m1)

summary(m2 <- zeroinfl(count ~ offset(log(volume)) + depth * stage, dist="negbin",link="logit", data = data.ontogeny.labrid))
lrtest(m1,m2)

data.ontogeny.labrid.old <- data.ontogeny.labrid
names(data.ontogeny.labrid)
data.ontogeny.labrid$obs <- 1:nrow(data.ontogeny.labrid)
str(data.ontogeny.labrid$obs)
print(data.ontogeny.labrid$obs)
plot(data.ontogeny.labrid$obs)
m3 <- glmer(count ~ offset(log(volume)) * depth * stage + (1|obs), family=poisson(link="log"), data=data.ontogeny.labrid,  method="ML")
summary(m3)
lrtest(m1,m2)
vuong(m1, m2)
```

