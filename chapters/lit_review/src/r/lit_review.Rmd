---
title: "Literature review analysis"
output:
  html_document: default
  html_notebook: default
---


```{r include=FALSE}
# Load libraries
library("grid")
library("gridExtra")
library("tidyverse")
library("ggthemes")

# Load external functions
source("sort_factor.R")
source("get_factor_proportion.R")
source("multiplot.R")
```

Load the data from the .csv file
```{r include=FALSE}
#check the columns loaded
data.all <- read_csv("../../data/lit_review.csv")
spec(data.all)
# Make column headers lowercase
colnames(data.all) <- tolower(colnames(data.all))
# Subset some data
data.fish <- filter(data.all, species_type == "Fish")

data.all <- data.all %>% mutate(movement = 
                                  circatidal_migration |
                                  pynocline_migration |
                                  halocline_migration |
                                  ontogentic_vertical_migration |
                                  vertical_swimming_ability |
                                  horizontal_swimming_ability |
                                  sinking_velocity  | 
                                  diel_vertical_migration) %>% mutate(settlement = sensory_extent > 0)
```

Summary of all the data
```{r}
#get a summary of all the data
summary(data.all)
```

# Current trends in biophysical modelling

Figure 1: Publication years
```{r}
data.all$published <- as.factor(data.all$published)
years.data <- data.all %>% select(paper_id, published) %>% distinct(paper_id, published)
years.plot <- ggplot(years.data,aes(published)) + geom_bar() + labs(x="Years of publication", y="Number of studies") + theme_few() + scale_colour_few()
years.plot
ggsave("../../figs/years.png", plot=years.plot, width=81, height=70, units="mm", dpi=96)
```

Figure 2: The taxa modelled
```{r}
taxa.plot <- ggplot(data=data.all,aes(sort_factor(species_type))) + 
  geom_bar() + coord_flip() + ylab("Number of models") + xlab("Modelled taxa") + 
  scale_x_discrete(labels = c("Cnidarian","Gastropod","Macroalgae","Echinoderm","Polychaete","Coral","Crustacean","Mollusc","Bivalvia","Fish","Generic")) +
  theme_few() + scale_colour_few()
ggsave("../../figs/taxa.png", plot=taxa.plot, width=81, height=60, units="mm", dpi=96)
taxa.plot
```

Table 2: Percentage of biological traits implemented.

PLD
```{r}
data.all$pld_type <- as.factor(data.all$pld_type)
pld_percentage <- length(which(!is.na(data.all$pld_type))) / length(data.all$pld_type) * 100
pld_percentage
```

Settlement competency
```{r}
data.all$settlement_competency_type <- as.factor(data.all$settlement_competency_type)
settlement_percentage <- length(which(!is.na(data.all$settlement_competency_type))) / length(data.all$settlement_competency_type) * 100
settlement_percentage
```

Spawning strategy
```{r}
data.all$run_mode <- as.factor(data.all$run_mode)
spawning.percentage <- length(which(data.all$run_mode == 'Forecast')) / length(data.all$run_mode) * 100
spawning.percentage
```

Mortality
```{r}
mortality.percentage <- length(which((data.all$mortality))) / length(data.all$mortality) * 100
mortality.percentage
```

Growth
```{r}
growth.percentage <- length(which((data.all$growth))) / length(data.all$growth) * 100
growth.percentage
```

Sensory ability
```{r}
sensory_ability.percentage <- length(which((data.all$sensory_ability))) / length(data.all$sensory_ability) * 100
sensory_ability.percentage
```

Orientation
```{r}
orientation.percentage <- length(which((data.all$orientation))) / length(data.all$orientation) * 100
orientation.percentage
```

Swimming behaviours
```{r}
movement.percentage <- length(which((data.all$movement))) / length(data.all$movement) * 100
movement.percentage
```

### Pelagic larval duration

Fixed pld
```{r}
pld.fixed.percentage <- length(which((data.all$pld_type == 'Fixed'))) / length(data.all$pld_type) * 100
pld.fixed.percentage
```

Variable pld
```{r}
pld.fixed.percentage <- length(which((data.all$pld_type == 'Variable'))) / length(data.all$pld_type) * 100
pld.fixed.percentage
```

Both pld
```{r}
pld.fixed.percentage <- length(which((data.all$pld_type == 'Both'))) / length(data.all$pld_type) * 100
pld.fixed.percentage
```

Range
```{r}
summary(data.all$pld_fixed)
```

#### Movement behaviours

Figure 3: Percentage of models over time (fish and inverts)
```{r}
papers.comparisons <- data.all %>% gather(behaviours, implemented,passive_movement,movement,orientation,settlement)
papers.comparisons <- papers.comparisons %>% select(paper_id,published,behaviours,implemented,species_type) %>% distinct(paper_id,published,behaviours,implemented,species_type) %>% filter(implemented == TRUE) %>% mutate(is_fish = species_type == 'Fish') %>% mutate(is_invert = species_type != 'Fish' & species_type != 'Generic' & species_type != 'Macroalgae') %>%
  mutate(taxa = if_else(is_fish == TRUE & is_invert == FALSE, 'Fish', if_else(is_invert == TRUE, 'Invertebrate', 'NA'))) %>% filter( taxa == 'Fish' | taxa == 'Invertebrate')

comparisons.plot <- ggplot(papers.comparisons, aes(published)) + geom_bar(aes(fill = behaviours)) +labs( x = "Publication year", y = "Number of models") +theme_few()+ theme(legend.title = element_blank(), legend.position = "top",legend.key.size = unit(5,'mm'),axis.text.x=element_text(angle=90)) +  scale_fill_grey(start = 0.3, end = 0.8, na.value="red",breaks=c("passive_movement","movement","settlement","orientation"), labels = c("Passive", "Movement", "Settlement", "Orientation")) + facet_grid(taxa ~ .)+ annotate(geom = "text", x = 7, y = 14, label = c("a","b")) + guides(fill=guide_legend(nrow=2,byrow=TRUE))


papers.comparisons.prop <- papers.comparisons %>%
  group_by(taxa, published, behaviours, taxa) %>%
  summarise (n = n()) %>%
  mutate(freq = n / sum(n))

prop.plot <- ggplot(papers.comparisons.prop, aes(x=published,y=freq, group=behaviours, colour=behaviours, shape=behaviours)) +labs( x = "Publication year", y = "Proportion")+ geom_line() + geom_point(size=2) + theme_few() + theme(legend.title = element_blank(), legend.position = "top",,axis.text.x=element_text(angle=90)) +  scale_colour_grey(breaks=c("passive_movement","movement","settlement","orientation"), labels = c("Passive", "Movement", "Settlement", "Orientation")) + facet_grid(taxa ~ .)+ scale_shape(breaks=c("passive_movement","movement","settlement","orientation"),labels = c("Passive", "Movement", "Settlement", "Orientation"))+ annotate(geom = "text", x = 7, y = 0.9, label = c("c","d"))+ guides(colour=guide_legend(nrow=2,byrow=TRUE))

p <- grid.arrange(comparisons.plot,prop.plot,ncol=2)
ggsave("../../figs/comparisons.png",plot=p,width = 169, height=120, units="mm",dpi=96)
#p <- grid.arrange(
#ggsave("figs/invert_prop.png",plot=p)

```

Overall
```{r}
passive.percentage <- length(which((data.all$passive_movement))) / length(data.all$passive_movement) * 100
passive.percentage
```

```{r}
passive.percentage <- length(which((data.fish$passive_movement))) / length(data.fish$passive_movement) * 100
passive.percentage
```

## Influence of modelling decisions on connectivity values

### Model Resolution

```{r}
resolution.data <- data.all %>% select(model_resolution_min,self_recruitment_mean,settlement_success_mean,
                                       local_retention_mean,distance_travelled_mean)
resolution.sr_lm <- lm(model_resolution_min ~ self_recruitment_mean, data = resolution.data)
resolution.ss_lm <- lm(model_resolution_min ~ settlement_success_mean, data = resolution.data)
resolution.lr_lm <- lm(model_resolution_min ~ local_retention_mean, data = resolution.data)
resolution.dd_lm <- lm(model_resolution_min ~ distance_travelled_mean, data = resolution.data)
summary(resolution.sr_lm)
summary(resolution.ss_lm)
summary(resolution.lr_lm)
summary(resolution.dd_lm)
resolution1 <- ggplot(resolution.data,aes(model_resolution_min,self_recruitment_mean)) +   
  geom_point() + 
  labs(x="", y="Self-recruitment (%)")+
  theme_few() + 
  scale_colour_few() + 
  scale_y_continuous(limits = c(0, 1.0)) +
  theme(axis.title = element_text(size = 9), axis.text = element_text(size = 8))
resolution2 <- ggplot(resolution.data,aes(model_resolution_min,local_retention_mean)) + 
  geom_point() + 
  labs(x="", y="Local retention (%)") +
  theme_few() + 
  scale_colour_few()+ 
  scale_y_continuous(limits = c(0, 1.0)) +
  theme(axis.title = element_text(size = 9), axis.text = element_text(size = 8))
resolution3 <- ggplot(resolution.data,aes(model_resolution_min,settlement_success_mean)) + 
  geom_point()+ 
  labs(x="", y="Settlement success (%)") +
  theme_few() + 
  scale_colour_few() + 
  scale_y_continuous(limits = c(0, 1.0)) +
  theme(axis.title = element_text(size = 9), axis.text = element_text(size = 8))
resolution4 <- ggplot(resolution.data,aes(model_resolution_min,distance_travelled_mean)) + 
  geom_point() + 
  labs(x="Model resolution (km^2)", y="Dispersal distance (km)") +
  theme_few() + 
  scale_colour_few() + 
  theme(axis.title = element_text(size = 9), axis.text = element_text(size = 8))
grid.arrange(resolution1,resolution2,resolution3,resolution4)
```

### Biological parameterisation


PLD

```{r}
data.pld <- filter(data.all, pld_fixed < 150)
pld.sr_lm <- lm(self_recruitment_mean ~ pld_fixed, data = data.pld)
pld.ss_lm <-
lm(settlement_success_mean ~ pld_fixed, data = data.pld)
pld.lr_lm <- lm(local_retention_mean ~ pld_fixed, data = data.pld)
pld.dd_lm <-
lm(distance_travelled_mean ~ pld_fixed, data = data.pld)
summary(pld.sr_lm)
summary(pld.lr_lm)
summary(pld.ss_lm)
summary(pld.dd_lm)
pld1 <- ggplot(data.pld, aes(pld_fixed, self_recruitment_mean)) +
  geom_point() + 
  labs(x = "", y = "") +
  theme_few() + 
  scale_colour_few() + 
  scale_y_continuous(limits = c(0, 1.0)) +
  theme(axis.text=element_text(size=8))
pld2 <- ggplot(data.pld, aes(pld_fixed, local_retention_mean)) + 
  geom_point() + 
  labs(x ="", y = "") +
  geom_smooth(method = lm,colour='black',linetype = "dashed") + 
  theme_few() + 
  scale_colour_few() + 
  scale_y_continuous(limits = c(0, 1.0)) +
  theme(axis.text=element_text(size=8))
pld3 <- ggplot(data.pld, aes(pld_fixed, settlement_success_mean)) + 
  geom_point() + 
  labs(x ="", y = "") +
  theme_few() + 
  scale_colour_few() + 
  scale_y_continuous(limits = c(0, 1.0)) +
  theme(axis.text=element_text(size=8))
pld4 <- ggplot(data.pld, aes(pld_fixed, distance_travelled_mean)) + 
  geom_point() + 
  labs(x ="PLD (days)", y = "") +
  theme_few() + 
  scale_colour_few() +
  theme(axis.title = element_text(size = 9), axis.text = element_text(size = 8))
grid.arrange(pld1, pld2, pld3, pld4)
```


### Settlement competency window
```{r}
data.all <- data.all %>% mutate(window=pld_fixed-settlement_competency_type_start)
window.sr_lm <- lm(window ~ self_recruitment_mean, data = data.all)
window.ss_lm <- lm(window ~ settlement_success_mean, data = data.all)
window.lr_lm <- lm(window ~ local_retention_mean, data = data.all)
window.dd_lm <- lm(window ~ distance_travelled_mean, data = data.all)
summary(window.sr_lm)
summary(window.ss_lm)
summary(window.lr_lm)
summary(window.dd_lm)
window1 <- ggplot(data.all,aes(window,self_recruitment_mean)) + 
  geom_point() + 
  geom_smooth(method=lm,colour='black',linetype = "dashed") + 
  labs(x="", y="")+
  theme_few() + 
  scale_colour_few() + 
  scale_y_continuous(limits = c(0, 1.0))+
  theme(axis.text=element_text(size=8))

window2 <- ggplot(data.all,aes(window,local_retention_mean)) + 
  geom_point() + 
  geom_smooth(method=lm,colour='black',linetype = "dashed")+ 
  labs(x="", y="")+
  theme_few() + 
  scale_colour_few() + 
  scale_y_continuous(limits = c(0, 1.0))+
  theme(axis.text=element_text(size=8))

window3 <- ggplot(data.all,aes(window,settlement_success_mean)) + 
  geom_point() + 
  labs(x="", y="")+ 
  theme_few()+
  scale_colour_few() + 
  scale_y_continuous(limits = c(0, 1.0)) +
  theme(axis.text=element_text(size=8))

window4 <- ggplot(data.all,aes(window,distance_travelled_mean)) + 
  geom_point() + 
  labs(x="Settlement window (days)", y="")+
  theme_few() + 
  scale_colour_few() + 
  theme(axis.title=element_text(size=9),axis.text=element_text(size=8))

p <- grid.arrange(resolution1, pld1, window1,
                  resolution2, pld2, window2,
                  resolution3, pld3, window3,
                  resolution4, pld4, window4,
                  ncol = 3)
ggsave("../../figs/metrics_panel.png",plot=p,width = 169, height=150, units="mm",dpi=96)
```


#### Mortality

Figure for mortality comparisons with metrics
```{r}
mortality.prop <- data.all %>% filter(mortality == TRUE) %>% group_by(mortality_function) %>% summarise (n = n()) %>% mutate(freq = n / sum(n))
mort1 <- ggplot(data.all, aes(mortality, self_recruitment_mean)) + geom_boxplot() + geom_jitter(width = 0.1)+ 
  labs(x="", y="Self-recruitment")+ theme_few() + scale_fill_grey() +
  scale_y_continuous(limits = c(0, 1.0)) + scale_x_discrete(labels=c("None","Included"))
mort2 <- ggplot(data.all, aes(mortality, local_retention_mean)) + geom_boxplot()+ geom_jitter(width = 0.1) +
  labs(x="", y="Local retention")+ theme_few() + scale_fill_few() +
  scale_y_continuous(limits = c(0, 1.0))+ scale_x_discrete(labels=c("None","Included"))
mort3 <- ggplot(data.all, aes(mortality, settlement_success_mean)) + geom_boxplot()+ geom_jitter(width = 0.1) +
  labs(x="Mortality", y="Settlement success")+ theme_few() + scale_fill_few() +
  scale_y_continuous(limits = c(0, 1.0))+ scale_x_discrete(labels=c("None","Included"))
mort4 <- ggplot(data.all, aes(mortality, distance_travelled_mean)) + geom_boxplot()+ geom_jitter(width = 0.1) +
  labs(x="Mortality", y="Dispersal distance (km)")+ theme_few() + scale_fill_few()+ scale_x_discrete(labels=c("None","Included"))
p <- grid.arrange(mort1,mort2,mort3,mort4)
ggsave("../../figs/mortality.png",plot=p,width = 169, height=120, units="mm",dpi=96)


bartlett.test(self_recruitment_mean ~ mortality, data=data.all)
bartlett.test(local_retention_mean ~ mortality, data=data.all)
bartlett.test(settlement_success_mean ~ mortality, data=data.all)
bartlett.test(distance_travelled_mean ~ mortality, data=data.all)
t.test(self_recruitment_mean ~ mortality, data=data.all, var.equal=TRUE)
t.test(local_retention_mean ~ mortality, data=data.all, var.equal=FALSE)
t.test(settlement_success_mean ~ mortality, data=data.all, var.equal=TRUE)
t.test(distance_travelled_mean ~ mortality, data=data.all, var.equal=FALSE)
```

#### Movement behaviours

Figure for the movement behaviours with metrics

```{r}
behaviour.data <- data.all %>% mutate(settlement = sensory_ability & passive_movement & !orientation) %>% 
  mutate(move_orien = movement & orientation & !sensory_ability) %>% 
  mutate(orien_settle = orientation & sensory_ability) %>% 
  mutate(move_settle = sensory_ability & movement & !orientation) %>% 
  mutate(no_behav = passive_movement == TRUE & sensory_ability == FALSE & orientation == FALSE) %>% 
  mutate(orien = orientation == TRUE & sensory_ability == FALSE & passive_movement == FALSE) %>% 
  mutate(move = passive_movement == FALSE & sensory_ability == FALSE & orientation == FALSE)

behaviour.data <- behaviour.data %>% gather(behaviours, implemented, no_behav,move,orien,settlement,move_orien,orien_settle,move_settle) %>% filter(implemented == TRUE)
behaviour.data$behaviours <- factor(behaviour.data$behaviours,levels = c('no_behav','move','settlement','move_settle','orien','orien_move','orien_settle'),ordered=TRUE)


behaviour1 <- ggplot(behaviour.data,aes(behaviours,self_recruitment_mean)) + geom_boxplot(na.rm = TRUE) + geom_jitter(width=0.1) + 
  scale_x_discrete(limits=c('no_behav','move','settlement','move_settle','orien','orien_move','orien_settle'),
                   labels=c("P","M","S","MS","O","OM","OS")) + theme_few() + scale_fill_few() +labs(x="", y="Self-recruitment") +
  scale_y_continuous(limits = c(0, 1.0))
behaviour2 <- ggplot(behaviour.data,aes(behaviours,local_retention_mean)) + geom_boxplot(na.rm = TRUE) + geom_jitter(width=0.1) +
  scale_x_discrete(limits=c('no_behav','move','settlement','move_settle','orien','orien_move','orien_settle'),
                   labels=c("P","M","S","MS","O","OM","OS")) + theme_few() + scale_fill_few() +labs(x="", y="Local retention") +
  scale_y_continuous(limits = c(0, 1.0))
behaviour3 <- ggplot(behaviour.data,aes(behaviours,settlement_success_mean)) + geom_boxplot(na.rm = TRUE) + geom_jitter(width=0.1) +
  scale_x_discrete(limits=c('no_behav','move','settlement','move_settle','orien','orien_move','orien_settle'),
                   labels=c("P","M","S","MS","O","OM","OS")) + theme_few() + scale_fill_few()+labs(x="Behaviour", y="Settlement success") +
  scale_y_continuous(limits = c(0, 1.0))
behaviour4 <- ggplot(behaviour.data,aes(behaviours,distance_travelled_mean)) + geom_boxplot(na.rm = TRUE) + geom_jitter(width=0.1) +
  scale_x_discrete(limits=c('no_behav','move','settlement','move_settle','orien','orien_move','orien_settle'),
                   labels=c("P","M","S","MS","O","OM","OS")) + theme_few() + scale_fill_few() +labs(x="Behaviour", y="Dispersal distance (km)")
p <- grid.arrange(behaviour1,behaviour2,behaviour3,behaviour4)

ggsave("../../figs/behaviours.png",plot=p,width = 169, height=120, units="mm",dpi=96)
```

