---
title: "Graph theory analysis for my theoreticla chapter"
output: html_notebook
---

Packages required
```{r, include=FALSE}
library(igraph)
library(NetIndices)
library(ggdendro)
```


Load the data
```{r,include=FALSE}
load(file="blackcod.rda")
load(file="reefs.rda")
```

Graph analysis for regions
```{r}

region.names <- c("Tweed","Byron","Ballina","Yamba","Solitary Is","Nambucca","Pt Macquarie","Crowdy Bay","Pt Stephens","Newcastle","Sydney","Wollongong","Jervis Bay","Ulladulla","Batemans Bay","Merimbula","Eden","Lord Howe Is","E&M Reefs")

X <- list(blackcod.2011.conn.regions[,-20],blackcod.2010.conn.regions[-20:-21],blackcod.2009.conn.regions[,-20:-21],blackcod.2008.conn.regions[,-20:-21],blackcod.2007.conn.regions[,-20:-21],blackcod.2006.conn.regions[,-20:-21],blackcod.2005.conn.regions[,-20:-21],blackcod.2004.conn.regions[,-20:-21])

Y <- do.call(cbind, X)
Y <- array(Y, dim=c(dim(X[[1]]),length(X)))

data.averages <- apply(Y, c(1,2), mean, na.rm=TRUE)

rownames(data.averages) <- unique(blackcod.2011.regions$settle.region)[-20]
colnames(data.averages) <-  unique(blackcod.2011.regions$settle.region)[-20]

graph <- graph_from_adjacency_matrix(data.averages[,-20], weighted = TRUE)
V(graph)$desc <- region.names
graph.simple <- simplify(graph, remove.loops=T)
E(graph)$width
plot(graph.simple, edge.arrow.size=0.2, edge.curved=0.1, edge.width=E(graph)$weight/500, vertex.label.family="Helvetica", vertex.label.color="black", vertex.label.cex=0.9,vertex.label=region.names, vertex.label.font=2)

plot(graph.simple, edge.arrow.size=0.2, edge.curved=0.1, edge.width=E(graph)$weight/500, vertex.label.family="Helvetica", vertex.label.color="gray40", vertex.label.cex=0.9,vertex.label=region.names, vertex.label.font=2, vertex.shape="none")
```

Hubs and Authorities
```{r}

as <- authority_score(graph)$vector
hs <- hub_score(graph)$vector
par(mfrow=c(1,2))
plot(graph.simple, vertex.size = as*50, edge.arrow.size=0.1,edge.curved=0.1,vertex.label=region.names, main="Links out", vertex.label.family="Helvetica", vertex.label.color="black", vertex.label.cex=0.7)
plot(graph, vertex.size = hs*50, edge.arrow.size=0.1, edge.curved=0.1,vertex.label=region.names,main="Links in", vertex.label.family="Helvetica", vertex.label.color="black", vertex.label.cex=0.7)
```


```{r}
graph.net <- graph
V(graph.net)$size <- 8
V(graph.net)$frame.color <- "white"
V(graph.net)$color <- "orange"
V(graph.net)$label =""
E(graph.net)$arrow.mode <- 0
plot(graph.net, layout=layout_with_lgl)
```

Sparsify the graph
```{r}
cut.off <- mean(E(graph)$weight)
par(mfrow=c(1,2))
graph.sp <- delete_edges(graph, E(graph)[weight < cut.off])
plot(graph.sp, edge.arrow.size=0.2, edge.curved=0.1, edge.width=E(graph)$weight/500, vertex.label.family="Helvetica", vertex.label.color="gray40", vertex.label.cex=0.9,vertex.label=region.names, vertex.label.font=2, vertex.shape="none",main="Strong")
graph.sp <- delete_edges(graph, E(graph)[weight < cut.off])
plot(graph.sp, edge.arrow.size=0.2, edge.curved=0.1, edge.width=E(graph)$weight/500, vertex.label.family="Helvetica", vertex.label.color="gray40", vertex.label.cex=0.9,vertex.label=region.names, vertex.label.font=2, vertex.shape="none",main="Weak")
```

```{r}
graph.m <- get.adjacency(graph, attr="weight", sparse = FALSE)
colnames(graph.m) <- region.names
rownames(graph.m) <- region.names
palf <- colorRampPalette(c("gold","dark orange"))
heatmap(graph.m, Rowv=NA, Colv=NA, col=palf(100), scale="col", margins=c(10,10))

```

```{r}
deg <- degree(graph, mode="all")
deg.dist <- degree_distribution(graph, cumulative=TRUE, mode="all")
plot( x=0:max(deg), y=1-deg.dist,pch=19, cex=1.2, col="orange", xlab="Degree", ylab="Freq")
```

```{r}
mpas <- incident_edges(graph, c(2,5,9,18,13,19,7,10,11), mode = "all")
ecol <- rep("gray80", ecount(graph))
ecol[mpas$NSW02] <- "orange"
ecol[mpas$NSW05] <- "orange"
ecol[mpas$NSW09] <- "orange"
ecol[mpas$NSW18] <- "orange"
ecol[mpas$NSW13] <- "orange"
ecol[mpas$NSW19] <- "orange"
ecol[mpas$NSW07] <- "orange"
ecol[mpas$NSW10] <- "orange"
ecol[mpas$NSW11] <- "orange"
vcol <- rep("grey80", vcount(graph))
vcol[c(2,5,9,18,13,19,7,10,11)] <- "gold"
plot(simplify(graph), vertex.color=vcol, edge.color=ecol, edge.arrow.size=0.2, edge.curved=0.1, edge.width=E(graph)$weight/500, vertex.label.family="Helvetica", vertex.label.color="black", vertex.label.cex=0.9,vertex.label=region.names, vertex.label.font=2, main="MPAs", layout=layout_in_circle)

par(mfrow=c(1,2))
plot(graph.simple, vertex.color=vcol, edge.color=ecol, vertex.size = as*50, edge.arrow.size=0.1,edge.curved=0.1,vertex.label=region.names, main="Links out", vertex.label.family="Helvetica", vertex.label.color="black", vertex.label.cex=0.7)
plot(graph, vertex.color=vcol, edge.color=ecol, vertex.size = hs*50, edge.arrow.size=0.1, edge.curved=0.1,vertex.label=region.names,main="Links in", vertex.label.family="Helvetica", vertex.label.color="black", vertex.label.cex=0.7)

```

Community detection
```{r}

ceb <- cluster_edge_betweenness(graph)
dendPlot(ceb, mode="hclust", label=region.names)
plot(ceb, graph, vertex.size = as*50, edge.arrow.size=0.1, edge.curved=0.1, vertex.label.family="Helvetica", vertex.label.color="black", vertex.label.cex=0.7,vertex.label=region.names)

clp <- cluster_fast_greedy(as.undirected(graph))
wc <- walktrap.community(graph)

png(filename="../../figs/dendo-all-regions.png")
dendPlot(wc, mode="hclust", label=region.names)
dev.off()
ggdendro(clp, rotate = FALSE, size = 2)

png(filename="../../figs/network-all-regions.png")
#dendPlot(wc, mode="hclust", label=region.names)
plot(wc,simplify(graph), edge.arrow.size=0.1, edge.curved=0.1, vertex.label.family="Helvetica", vertex.label.color="black", vertex.label.cex=1.0,vertex.label=region.names, edge.width=E(graph)$weight/1000, layout=layout_nicely, vertex.label.dist=1, vertex.size=5)
dev.off()


plot(simplify(graph), edge.arrow.size=0.2, edge.curved=0.1, edge.width=E(graph)$weight/500, vertex.label.family="Helvetica", vertex.label.color="black", vertex.label.cex=0.9,vertex.label=region.names, vertex.label.font=2, main="MPAs", layout=spring)

p1 <- ggdraw() + draw_image("../../figs/dendo-all-regions.png")
p2 <- ggdraw()+ draw_image("../../figs/network-all-regions.png")
grid <- plot_grid(p1,p2, labels="AUTO", align="hv", nrow=2)
save_plot("../../figs/graph.png", grid, nrow=2, ncol=1, base_aspect_ratio = 1.2)



sg <- spinglass.community(graph)
graph5 <- qgraph(cormatrix, graph="glasso", layout="spring", sampleSize = nrow(data),groups=group.spinglass, 
                 vsize=7, cut=0, maximum=.45, border.width=1.5,
                 color=c("red", "orange", "white", "blue", "green"), title="igraph spinglass")
layout <-layout.fruchterman.reingold(graph)
new_cols <- c("white", "red", "black")[membership(sg)]
plot(sg, graph, col=new_cols, mark.border="black", mark.col=c("tan", "pink", "lightgray"), 
    layout=layout, vertex.label=NA, vertex.size=5, edge.arrow.size=.2)

dhc <- as.dendrogram(clp)
# Rectangular lines
ddata <- dendro_data(dhc, type = "rectangle")
p <- ggplot(segment(ddata)) + 
  geom_segment(aes(x = x, y = label, xend = xend, yend = yend)) + 
  coord_flip() + 
  scale_y_reverse(expand = c(0.2, 0))
p

plot(clp, as.undirected(graph), edge.arrow.size=0.1, edge.curved=0.1, vertex.label.family="Helvetica", vertex.label.color="black", vertex.label.cex=0.7,vertex.label=region.names)

V(graph)$community <- sg$membership
clrs <- adjustcolor(c("tomato","gold","yellowgreen","blue","brown"), alpha=0.5)
plot(graph, vertex.color=clrs[V(graph)$community],edge.arrow.size=0.2, edge.curved=0.1, edge.width=E(graph)$weight/1000,vertex.label.family="Helvetica", vertex.label.color="black", vertex.label.cex=0.7,vertex.label=region.names, layout=layout)
```

```{r}
graph.indicies <- GenInd(get.adjacency(graph, sparse=FALSE))
graph()
```

