---
title: "Appliedchapter - nMDS analysis"
output: html_notebook
---

Packages required
```{r, include=FALSE}
library(tidyverse)
library(vegan)
library(ggdendro)
library(RColorBrewer)
library(FactoMineR)
library(factoextra)
source("applied-functions.R")
```

Load data
```{r,include=FALSE}
load(file="blackcod.rda")
load(file="nmds.rda")
```

Create community matrices
```{r}
reefs.community_matrix <- get_community_matrix(reefs.data,TRUE)
regions.community_matrix <- get_community_matrix(regions.data,FALSE)
```

Labels for the data
```{r}
years <- c("2011","2010","2009","2008","2007","2006","2005","2004")
applied <- data.frame(years)
region.names <- c("Tweed","Byron","Ballina","Yamba","Solitary Is","Nambucca","Pt Macquarie","Crowdy Bay","Pt Stephens","Newcastle","Sydney","Wollongong","Jervis Bay","Ulladulla","Batemans Bay","Merimbula","Eden","Lord Howe Is","E&M Reefs")
```

NMDS using reef settlement sites
```{r}

# nMDS 
reefs.nmds <- metaMDS(regions.community_matrix, distance="bray", k=2, trymax=100)
#plot(reefs.nmds, disp="sites")
#ordiellipse(reefs.nmds, group=theoretical$scenarios, col=2:4, kind = "ehull", lwd=2, label = TRUE)
#ordihull(reefs.nmds, group=applied$years, col=2:4, draw = "polygon", lwd=2, label=FALSE)
MDS_xy <- data.frame(reefs.nmds$points)
MDS_xy$years <- applied$years
reefs.nmds.plot <- ggplot(MDS_xy, aes(MDS1, MDS2, colour=years)) + geom_point(size=3) + theme_bw() + theme(legend.position = "right") + scale_shape(name="")  + scale_color_brewer(name = "", palette = "Set1") 
ggsave("../../figs/nmds-yearly.png", reefs.nmds.plot)
#ordilabel(reefs.nmds)
```

NMDS using region settlement sites
```{r}
#png('../../figs/regions-nmds.png')
regions.nmds <- metaMDS(regions.community_matrix,distance="bray", k=2)
plot(regions.nmds, display="sites")
#orditorp(regions.nmds,display = "species", col="black", air=0.01)
#orditorp(regions.nmds,display = "sites", cex=1.25, air=0.01)
ordiellipse(regions.nmds, group=applied$years, col=2:4, kind = "ehull", lwd=2, label = TRUE)
#ordihull(regions.nmds, group=theoretical$scenarios, col=2:4, draw = "polygon", lwd=2, label=FALSE)
MDS_xy <- data.frame(regions.nmds$points)
MDS_xy$years <- applied$years
regions.nmds.plot <- ggplot(MDS_xy, aes(MDS1, MDS2, colour=years, shape=years)) + geom_jitter(width=0.015,size=3) + theme_bw() + theme(legend.position = "bottom")+ scale_shape(name="")  + scale_color_brewer(name = "", palette = "Paired") 
ggsave("../../figs/nmds-regions.png", regions.nmds.plot)

#dev.off()
regions.nmds$stress
```

NNDS using all reefs (or regions)
```{r}
regions <- colnames(blackcod.2011.conn.regions)
data.2011 <- as_tibble(blackcod.2011.conn.regions)
data.2011$sites <- regions[-20]
data.2011$year <- rep(c("2011"))
data.2010 <- as_tibble(blackcod.2010.conn.regions)
data.2010$sites <- regions[-20]
data.2010$year <- rep(c("2010"))
data.2009 <- as_tibble(blackcod.2009.conn.regions)
data.2009$sites <- regions[-20]
data.2009$year <- rep(c("2009"))
data.2008 <- as_tibble(blackcod.2008.conn.regions)
data.2008$sites <- regions[-20]
data.2008$year <- rep(c("2008"))
data.2007 <- as_tibble(blackcod.2007.conn.regions)
data.2007$sites <- regions[-20]
data.2007$year <- rep(c("2007"))
data.2006 <- as_tibble(blackcod.2006.conn.regions)
data.2006$sites <- regions[-20]
data.2006$year <- rep(c("2006"))
data.2005 <- as_tibble(blackcod.2005.conn.regions)
data.2005$sites <- regions[-20]
data.2005$year <- rep(c("2005"))
data.2004 <- as_tibble(blackcod.2004.conn.regions)
data.2004$sites <- regions[-20]
data.2004$year <- rep(c("2004"))

community <- data.2011 %>% full_join(data.2010) %>% full_join(data.2009) %>% full_join(data.2008) %>% full_join(data.2007) %>% full_join(data.2006) %>% full_join(data.2005) %>% full_join(data.2004)

community_matrix <- dplyr::select(community, -year, -sites)
community_matrix[is.na(community_matrix)] <- 0

nmds <- metaMDS(community_matrix,distance="bray", k=2)
#plot(nmds)

MDS_xy <- data.frame(nmds$points)
MDS_xy$year <- community$year
MDS_xy$sites <- community$sites
#color = colorRampPalette(rev(brewer.pal(n = 8, name = "Paired"))(19))
# Classic palette BuPu, with 4 colors
coul = brewer.pal(9, "Set1") 
 
# I can add more tones to this palette :
coul = colorRampPalette(coul)(19)

nmds.plot.years <- ggplot(MDS_xy, aes(MDS1, MDS2, colour=year)) + geom_jitter(width=0.015,size=3) + theme_bw() + theme(legend.position = "right")   + scale_colour_brewer(name="", palette="Set1")

nmds.plot.regions <- ggplot(MDS_xy, aes(MDS1, MDS2, colour=sites)) + geom_point(size=3) + theme_bw() + theme(legend.position = "right")   + scale_colour_manual(values = coul, labels=region.names) + stat_ellipse() 
ggsave("../../figs/nmds-regions.png", nmds.plot.regions)


adonis(community_matrix ~ year, community, perm=200)

mod <- with(community, betadisper(vegdist(community_matrix,"bray"), year))


phase1.mva.model <- manyglm(phase1.mva~phase1.regions.mva$behaviour)
anova(phase1.mva.model)
```
CA analysis
```{r}

blackcod.ca <- CA(regions.community_matrix, graph=FALSE)
summary(blackcod.ca)
fviz_screeplot(blackcod.ca, addlabels=TRUE)
blackcod.biplot <- fviz_ca_biplot(blackcod.ca, map="colgreen", arrow=c(FALSE,TRUE), repel=TRUE, title = "") + theme_classic()
fviz_ca_row(blackcod.ca, repel=TRUE)
fviz_ca_col(blackcod.ca, repel=TRUE)
row <- get_ca_row(blackcod.ca)
row$contrib
ggsave("../../figs/blackcod-ca.png",blackcod.biplot)

```

Biodiversity index
```{r}
phase1.reefs.data.t <- t(phase1.reefs.data)
names(phase1.reefs.data.t) <- phase1.reefs.data.t[1,]
phase1.reefs.data.t <- phase1.reefs.data.t[-1,]
phase1.reefs.data.t[is.na(phase1.reefs.data.t)] <- 0

# shannons
phase1.reefs.shannon <- diversity(phase1.reefs.data.t)
phase1.reefs.shannon
##phase1.reefs.simpson <- diversity(phase1.reefs.data.t,"simpson")
#anova(phase1.reefs.shannon)
phase1.reefs.bray = vegdist(phase1.reefs.data.t, "bray")
hist(phase1.reefs.bray)
phase1.reefs.cluster <- hclust(phase1.reefs.bray, method="average")
phase1.reefs.dendrogram <- as.dendrogram(phase1.reefs.cluster) 
plot(phase1.reefs.cluster, xlab ="Behaviours" , ylab = "Bray-Curtis dissimilarity", hang=-1, cex = 1)
phase1.plot <- ggdendrogram(phase1.reefs.cluster, theme_dendro = FALSE, rotate=TRUE) + theme_classic() + labs(x="Behaviour scenarios", y="Bray-Curtis dissimilarity")
phase1.plot
```

Biodiversity index for Phase 2
```{r}
phase2.reefs.data.t <- t(phase2.reefs.data)
names(phase2.reefs.data.t) <- phase2.reefs.data.t[1,]
phase2.reefs.data.t <- phase2.reefs.data.t[-1,]
phase2.reefs.data.t[is.na(phase2.reefs.data.t)] <- 0

# shannons
phase2.reefs.shannon <- diversity(phase2.reefs.data.t)
phase2.reefs.shannon
##phase2.reefs.simpson <- diversity(phase2.reefs.data.t,"simpson")
#anova(phase2.reefs.shannon)
phase2.reefs.bray = vegdist(phase2.reefs.data.t, "bray")
hist(phase2.reefs.bray)
phase2.reefs.cluster <- hclust(phase2.reefs.bray, method="average")
phase2.reefs.dendrogram <- as.dendrogram(phase2.reefs.cluster) 
plot(phase2.reefs.cluster, xlab ="Behaviours" , ylab = "Bray-Curtis dissimilarity", hang=-1, cex = 1)
phase2.plot <- ggdendrogram(phase2.reefs.cluster, theme_dendro = FALSE, rotate=TRUE) + theme_classic() + labs(x="OVM strategies", y="Bray-Curtis dissimilarity")
phase2.plot
```

Biodiversity index for Phase 3
```{r}
phase3.reefs.data.t <- t(phase3.reefs.data)
names(phase3.reefs.data.t) <- phase3.reefs.data.t[1,]
phase3.reefs.data.t <- phase3.reefs.data.t[-1,]
phase3.reefs.data.t[is.na(phase3.reefs.data.t)] <- 0

# shannons
phase3.reefs.shannon <- diversity(phase3.reefs.data.t)
phase3.reefs.shannon
#anova(phase3.reefs.shannon)

phase3.reefs.bray = vegdist(phase3.reefs.data.t, "bray")
hist(phase3.reefs.bray)
phase3.reefs.cluster <- hclust(phase3.reefs.bray, method="average")
phase3.reefs.dendrogram <- as.dendrogram(phase3.reefs.cluster) 
plot(phase3.reefs.cluster, xlab ="Behaviours" , ylab = "Bray-Curtis dissimilarity", hang=-1, cex = 1)
phase3.plot <- ggdendrogram(phase3.reefs.cluster, theme_dendro = FALSE, rotate=TRUE) + theme_classic() + labs(x="OVM strategies", y="Bray-Curtis dissimilarity")
phase3.plot
```

```{r}
grid <- plot_grid(phase1.plot,phase2.plot, labels=c("a","b"), align ="h")
save_plot("../../figs/cluster.png", grid, ncol=2, nrow=1)
```

MVABUND
```{r}
phase1.regions.mva <- phase1.regions.data %>% rownames_to_column %>% gather(behaviour,value,-settle.region) %>% spread(settle.region,value)
phase1.regions.mva <- phase1.regions.mva[-9,-19]
phase1.regions.mva$behaviour <- factor(phase1.regions.mva$behaviour)
phase1.regions.mva <- japply( phase1.regions.mva, which(sapply(phase1.regions.mva,class)=="character"),as.numeric)
phase1.regions.mva
phase1.mva <- mvabund(phase1.regions.mva[,2:18])

par(mar=c(2,10,2,2)) # adjusts the margins
boxplot(phase1.regions.mva[,2:18],horizontal = TRUE,las=2)
meanvar.plot(phase1.mva)
plot(phase1.mva~phase1.regions.mva$behaviour, height=9,width=9, cex.axis=0.8, cex=0.8)

phase1.mva.model <- manyglm(phase1.mva~phase1.regions.mva$behaviour)
anova(phase1.mva.model)
```

Settlement reef richness
```{r}
rowSums(phase1.reefs.data.t > 0)
rowSums(phase2.reefs.data.t > 0)
rowSums(phase3.reefs.data.t > 0)
```

