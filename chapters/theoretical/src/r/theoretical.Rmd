---
title: "R Notebook"
output: html_notebook
---

```{r}
require(maps)
require(mapdata)
require(rgdal)
require(ggmap)
require(broom)
require(multcompView)
require(cowplot)
require(magick)
library(RColorBrewer)
library(tidyverse)
```


OVM example diagram
```{r}

ovm <- tribble(
  ~stage, ~depth, ~probability,
  "preflexion", 0, 60,
  "preflexion", 25, 20,
  "preflexion", 50, 10,
  "preflexion", 75, 10,
  "flexion", 0, 25,
  "flexion", 25, 38,
  "flexion", 50, 30,
  "flexion", 75, 7,
  "postflexion", 0, 10,
  "postflexion", 25, 17,
  "postflexion", 50, 43,
  "postflexion", 75, 30
)

ovm$stage <- factor(ovm$stage, levels=c("preflexion","flexion","postflexion"))
ovm$depth <- factor(ovm$depth, levels=c("75","50","25","0"))
p <- ggplot(ovm, aes(x=depth, y=probability, group=stage, colour=stage)) + geom_line() + geom_point() + theme_classic()  + labs(x="Depth (m)", y="Proportion") + coord_flip() + theme(legend.position = "right")
ggplot2::ggsave("../../figs/ovm-example.png",p) 


```


Study sites diagram
```{r}
#australia <- map("worldHires", "Australia", xlim=c(140,160), ylim=c(-45,-10), col="gray90", fill=TRUE)
#coast = get_openstreetmap(c(147.041,-36.593,159.662,-24.247))
legend.names <- c("1 (Tweed)","2 (Byron)","3 (Ballina)","4 (Yamba)","5 (Solitary Is)","6 (Nambucca)","7 (Pt Macquarie)","8 (Crowdy Bay)","9 (Pt Stephens)","10 (Newcastle)","11 (Sydney)","12 (Wollongong)","13 (Jervis Bay)","14 (Ulladulla)","15 (Batemans)","16 (Merimbula)","17 (Eden)")

centre <- geocode("Sydney, AU")
coast <- get_map(c(lon=151, lat=-33), maptype=c("hybrid"), source="google")
load(file="reefs.rda")
sites <- filter(reefs.id, RELEASE)
australia <- ggmap(coast)

coul = brewer.pal(9, "Set1")
coul = colorRampPalette(coul)(17)
map <- australia + geom_point(aes(x=LON_RELEASE, y=LAT_RELEASE, group=REGION, colour=REGION), size=1.5, data=sites) + theme(legend.position = "right") + labs(x="Longitude", y="Latitude") + scale_color_manual(labels = c("1 (Tweed)","2 (Byron)","3 (Ballina)","4 (Yamba)","5 (Solitary Is)","6 (Nambucca)","7 (Pt Macquarie)","8 (Crowdy Bay)","9 (Pt Stephens)","10 (Newcastle)","11 (Sydney)","12 (Wollongong)","13 (Jervis Bay)","14 (Ulladulla)","15 (Batemans)","16 (Merimbula)","17 (Eden)"), name="Source region", values = coul) 

map


#eddies <- ggdraw() + draw_image("../../figs/nsw-eddies.gif", scale=0.9)
#plot_grid(map,eddies, labels="AUTO")
ggsave("../../figs/release-sites.png", map)
```


OVM proportions diagram

```{r}
ovm.data <- read_csv("../../data/ovm.csv")
ovm.data <- ovm.data %>% gather(key= stage, value=proportion, 3:5)
ovm.data$stage <- factor(ovm.data$stage, levels=c("preflexion","flexion","postflexion"))
ovm.plot <- ggplot(data= ovm.data, aes(x=depth, y=proportion, group=stage, colour=stage)) + geom_line() + geom_point() + facet_wrap(~fish, ncol=2, shrink = TRUE) + coord_flip() + theme_bw() + labs(x="Depth", y="Proportion") + scale_color_discrete(name="Ontogenetic stage") + theme(legend.position = "right")
ggsave("../../figs/ovm-strategies.png", ovm.plot)



data.ontogeny$stage.r <- factor(data.ontogeny$stage, levels=c("PRE","FLE","POS"))
data.ontogeny$depth.r <- factor(data.ontogeny$depth, levels=c("75","25","0"))
ggplot(data=data.ontogeny, aes(y=conc.m, x=depth.r, group=stage.r, color=stage.r)) + facet_wrap(~family, scales="free", ncol=4, shrink = TRUE) + stat_summary_bin(fun.y="mean", geom="line", position=position_dodge(width=0.5), show.legend=FALSE) + stat_summary_bin(fun.y="mean", geom="point", position=position_dodge(width=0.5),size=2) + stat_summary(fun.data = "mean_cl_boot", geom = "linerange",position=position_dodge(width=0.5),show.legend = FALSE) + labs(x="Depth (m)", y=expression("Concentration per 1000 "~m^{3})) + theme_classic() + coord_flip() + scale_color_discrete(name="", labels=c("Preflexion","Flexion","Postflexion")) + theme(legend.position = c(0.85,0.15), legend.justification = c(0.3,0)) 
```


